var uAdmin=(function(){var register=function(){var checkClass=function(parent,parent_str){for(var i in parent.reg){if(parent.reg[parent_str]){return parent.reg[parent_str]}else{return checkClass(parent.reg[i],parent_str)}}return false};var name,value,parent,params=arguments[0];if(params.length){if(typeof params[0]=="object"){if(Object.prototype.toString.call(params[0])=="[object Array]"){return false}for(var i in params[0]){register([i,params[0][i],params[1]||null])}return true}else{if(typeof params[0]=="string"){if(typeof params[1]=="undefined"){return false}name=params[0];value=params[1];parent=params[2]||null}else{return false}}}else{return false}if(!parent){parent=uAdmin}if(typeof parent=="string"){parent=checkClass(uAdmin,parent)}if(typeof parent!="function"){return false}var isclass=false;name=name.split(".");if(name.length>1){isclass=true}name=name.pop();var reg=function(){parent.reg[name]=value;if(isclass){parent.reg[name].isclass=true}};if(!parent.reg){parent.reg=reg}reg();return true};function uAdmin(){if(uAdmin.prototype.instanse==null){uAdmin.prototype.instanse=new uAdmin.prototype.get()}register(arguments);return uAdmin.prototype.instanse}uAdmin.prototype.get=function(){return this};uAdmin.prototype.get.prototype=uAdmin.prototype;uAdmin.prototype.init=function(){uAdmin.load(uAdmin);delete uAdmin.reg;delete uAdmin.load};if(typeof JSON=="undefined"){JSON={parse:function(str){try{if(str.match(/^{/g)){var val=eval("("+str+")");if(Object.prototype.toString.call(val)=="[object Object]"){return val}}throw new SyntaxError("JSON.parse: unexpected end of data")}catch(e){throw new SyntaxError("JSON.parse: unexpected end of data")}}}}var data=jQuery.ajax({url:location.pathname+".json"+location.search,dataType:"json",async:false});uAdmin("data",JSON.parse(data.responseText));uAdmin.load=function(parent){for(var i in parent.reg){if(parent.reg[i].reg){uAdmin.load(parent.reg[i])}if(parent.reg[i].isclass){var extend=function(usedClass,extendClass){for(var i in extendClass){usedClass.prototype[i]=extendClass[i]}return new usedClass()};if(parent==uAdmin){parent[i]=new parent.reg[i](extend)}else{parent.prototype[i]=new parent.reg[i](extend)}}else{if(parent==uAdmin){parent[i]=parent.reg[i]}else{parent.prototype[i]=parent.reg[i]}}}};return uAdmin})();jQuery(document).ready(function(){uAdmin().init()});uAdmin(".panel",function(b){function a(){var o=this;jQuery("html").addClass("u-eip");var h=jQuery('<div id="u-panel-holder" />').appendTo("body");var f=jQuery('<div id="u-show_hide_btn" />').appendTo(h);f.click(function(){o.swap(this)});var m=jQuery('<div id="u-quickpanel" />').appendTo(h);jQuery('\n			<div id="exit" title="'+getLabel("js-panel-exit")+'">&#160;</div>\n		').appendTo(m).click(function(){window.location="/users/logout/";return false});jQuery('\n			<div id="help" title="'+getLabel("js-panel-documentation")+'">&#160;</div>\n		').appendTo(m).click(function(){window.open("http://help.umi-cms.ru/admin_panel.htm");return false});var n=jQuery('\n			<div id="butterfly">\n				<span class="in_ico_bg">&#160;</span>'+getLabel("js-panel-modules")+'\n				<div class="bg">\n					<ul id="u-mods-cont-left" />\n					<ul id="u-mods-cont-right" />\n					<div class="clear separate" />\n					<ul id="u-mods-utils" />\n					<ul id="u-mods-admin" />\n					<div class="clear" />\n				</div>\n			</div>\n		').appendTo(m);var e=jQuery('\n			<div id="edit_menu" title="'+getLabel("js-panel-edit-menu")+'">\n				<span class="in_ico_bg">&#160;</span>\n				<div>\n					<ul id="u-docs-edit"/>\n					<span class="clear" />\n				</div>\n			</div>\n		').appendTo(m);var j=jQuery('\n			<div id="last_doc">\n				<span class="in_ico_bg" />\n				'+getLabel("js-panel-last-documents")+'\n				<div>\n					<ul id="u-docs-recent" />\n					<span class="clear" />\n				</div>\n			</div>\n		').appendTo(m);j.click(function(){o.changeAct(this)});var g=jQuery('\n			<div id="changelog_dd" style="display:none;">\n				<span class="in_ico_bg">&#160;</span>\n				'+getLabel("js-panel-history-changes")+'\n				<div>\n					<ul id="u-changelog" />\n					<span class="clear" />\n				</div>\n			</div>\n		').appendTo(m);g.click(function(){o.changeAct(this)});var l=jQuery('\n			<div id="note">\n				<span class="in_ico_bg">&#160;</span>\n				'+getLabel("js-panel-note")+"\n			</div>\n		").appendTo(m);jQuery('\n			<div id="seo">				<span class="in_ico_bg">&#160;</span>\n				'+getLabel("module-seo")+"\n			</div>\n		").appendTo(m).click(function(){window.location="/admin/seo/"});jQuery(document).bind("click",function(p){if(!jQuery(p.target).parents("#u-quickpanel").size()){o.changeAct()}});if(!jQuery.cookie("eip-panel-state-first")){m.css({overflow:"hidden",height:"0"});f.addClass("collapse");m.delay(500).animate({height:"25px"},500,function(){jQuery(this).css("overflow","visible");f.removeClass("collapse")});m.fadeTo(300,0.3);m.fadeTo(300,1);jQuery.cookie("eip-panel-state","",{path:"/",expires:0});var d=new Date();d.setTime(d.getTime()+(30*24*60*60*1000));jQuery.cookie("eip-panel-state-first","Y",{path:"/",expires:d})}var k=function(w){jQuery('<link type="text/css" rel="stylesheet" href="/styles/skins/_eip/css/theme.css" />').appendTo("head");var v,t;for(v in w.documents.recent.page){v=w.documents.recent.page[v];jQuery("ul#u-docs-recent",j).append('<li><a href="'+v.link+'">'+v.name+"</a></li>")}var s=0;for(v in w.documents.editable.page){v=w.documents.editable.page[v];for(t in w.modules.module){t=w.modules.module[t];if(t.name==v.basetype.module){continue}}jQuery("ul#u-docs-edit",m).append('<li><a href="'+(uAdmin.lang_prefix?"/"+uAdmin.lang_prefix:"")+v["edit-link"]+'">'+v.name+"</a></li>");s++}if(s){e.click(function(){o.changeAct(this)})}else{e.hide(0)}s=0;for(t in w.modules.module){t=w.modules.module[t];var p;switch(t.type){case"system":p="ul#u-mods-utils";break;case"util":p="ul#u-mods-admin";break;default:p=(++s%2)?"ul#u-mods-cont-left":"ul#u-mods-cont-right"}jQuery(p,n).append('<li><a href="'+(uAdmin.lang_prefix?"/"+uAdmin.lang_prefix:"")+"/admin/"+t.name+'/">'+t.label+"</a></li>")}if(s){n.click(function(){o.changeAct(this)}).addClass("butterfly_hover")}if(typeof w.changelog!="undefined"){for(var r in w.changelog.revision){r=w.changelog.revision[r];var q=r.date.std+(r.author.name?" - "+r.author.name:"")+(r.active=="active"?"&nbsp;&nbsp;&nbsp;&larr;":"");var u=r.link+"?force-redirect="+window.location.pathname;jQuery("#u-changelog",g).append('<li><a href="'+u+'">'+q+"</a></li>")}g.css("display","")}else{g.css("display","none")}if(typeof w.tickets!="undefined"&&typeof uAdmin.tickets=="object"){uAdmin.tickets.draw(w)}else{l.remove()}};var c="/admin/content/frontendPanel/.json?links";c+="&ts="+Math.round(Math.random()*1000);jQuery.ajax({url:c,dataType:"json",success:k})}a.prototype.swap=function(d){var c=jQuery("#u-quickpanel").css("height");if(c=="0px"){return this.expand(d)}else{if(uAdmin.eip.meta.enabled){jQuery("#u-quickpanel #meta").trigger("click")}return this.collapse(d)}};a.prototype.expand=function(d){var c=jQuery("#u-quickpanel");c.css("overflow","visible");c.animate({height:"25px"},700);jQuery(d).removeClass("collapse");jQuery.cookie("eip-panel-state","",{path:"/",expires:0})};a.prototype.collapse=function(e){var d=jQuery("#u-quickpanel");d.css("overflow","hidden");d.animate({height:"0"},700);jQuery(e).addClass("collapse");var c=new Date();c.setTime(c.getTime()+(30*24*60*60*1000));jQuery.cookie("eip-panel-state","collapsed",{path:"/",expires:c})};a.prototype.loadRes=function(c,e,f){var d;switch(c){case"js":case"text/javascript":d=document.createElement("script");d.src=e;d.charset="utf-8";break;case"css":case"text/css":d=document.createElement("link");d.href=e;d.rel="stylesheet";break;default:return}document.body.parentNode.firstChild.appendChild(d);if(typeof f=="function"){jQuery(document).one("ready",f)}};a.prototype.changeAct=function(f){var d=(uAdmin.eip&&uAdmin.eip.enabled)?"[id != 'edit']":"",c=jQuery("#save_edit");if(!f){jQuery("#u-quickpanel .act div:first").hide();jQuery("#u-quickpanel .act"+d).removeClass("act")}else{if(jQuery(f).hasClass("act")){jQuery("#u-quickpanel .act div:first").hide();jQuery("#u-quickpanel .act"+d).removeClass("act");if(f.id=="edit"){c.css("display","none")}}else{var e=jQuery("#u-quickpanel .act"),g=false;if(e.size()){jQuery("#u-quickpanel .act div:first").hide();jQuery("#u-quickpanel .act"+d).removeClass("act");if(f.id=="edit"&&!d){c.css("display","none")}}if(jQuery.browser.opera){g=jQuery(f).width()}jQuery(f).addClass("act");if(g){jQuery(f).width(g)}jQuery("#u-quickpanel .act div:first").show();if(f.id=="edit"){c.css("display","block")}}}if(jQuery(f).attr("id")!="meta"&&uAdmin.eip&&uAdmin.eip.meta.enabled){jQuery("#u-quickpanel #meta").addClass("act")}};a.prototype.editInAdmin=function(c){if(c=="enable"){jQuery(document).bind("keypress",this.editInAdmin.bindEvents)}if(c=="disable"){jQuery(document).unbind("keypress",this.editInAdmin.bindEvents)}};a.prototype.editInAdmin.bindEvents=function(c){if(c.shiftKey){switch(c.charCode||c.keyCode){case 68:case 100:case 1042:case 1074:jQuery("#u-quickpanel #edit_menu").each(function(d,e){uAdmin.panel.changeAct(e)});break}}};return b(a,this)});uAdmin(".tickets",function(b){function a(){var c=function(f){var d=this;d.params=f;(function e(){d.node=jQuery('<div class="u-ticket" />').appendTo("body");if(f.message){d.createMessage()}d.update()})()};c.prototype.resetSelection=function(){if(document.selection&&document.selection.empty){document.selection.empty()}else{if(window.getSelection){var d=window.getSelection();if(d&&d.removeAllRanges){d.removeAllRanges()}}}};c.prototype.createMessage=function(){var d=this;d.messageNode=jQuery('<div class="u-ticket-comment"><div /><textarea /><a /></div>').appendTo("body");if(d.params.message){jQuery("div",d.messageNode).html(d.params.message.authorName+" ("+d.params.message.authorLogin+")");jQuery("textarea",d.messageNode).attr("value",d.params.message.text)}jQuery("a",d.messageNode).html(getLabel("js-ticket-delete"));jQuery("textarea",d.messageNode).bind("change",function(){d.save()});jQuery("a",d.messageNode).bind("click",function(){d.del()})};c.prototype.del=function(){var d=this;if(this.node){this.node.remove()}if(this.messageNode){this.messageNode.remove()}if(d.params.id){var e="/content/tickets/delete/"+d.params.id+"/";jQuery.get(e)}};c.prototype.save=function(){var d=this;var f=d.params.id?"modify":"create";var e="/content/tickets/"+f+"/"+d.params.id+"/";e+="?ts="+Math.round(Math.random()*1000);jQuery.ajax({type:"POST",url:e,dataType:"json",data:{x:d.params.x,y:d.params.y,width:d.params.width,height:d.params.height,message:jQuery("textarea",d.params.messageNode).attr("value"),referer:window.location.toString()},success:function(g){d.params.id=g.id}})};c.prototype.update=function(){var d=this;d.node.css({top:parseInt(d.params.y),left:parseInt(d.params.x),width:d.params.width,height:d.params.height,opacity:0.3});if(d.messageNode){d.messageNode.css({top:parseInt(d.params.y)+parseInt(d.params.height),left:parseInt(d.params.x)+parseInt(d.params.width)})}if(uAdmin.tickets.disabled){jQuery(d.node).add(d.messageNode).hide()}};c.prototype.listen=function(){var d=this,g=d.params.x,f=d.params.y,h,e;jQuery(document).bind("mousemove",function(j){d.resetSelection();h=j.pageX;e=j.pageY;if(h>g){d.params.width=h-g}else{h=g;d.params.x=j.pageX;d.params.width=h-d.params.x}if(e>f){d.params.height=e-f}else{e=f;d.params.y=j.pageY;d.params.height=e-d.params.y}d.update()});jQuery(document).one("mouseup",function(){jQuery(document).unbind("mousemove");d.update();d.save();uAdmin.tickets.isInit=false})};this.ticket=c}a.prototype.initNewTicket=function(){if(!uAdmin.tickets.created){alert(getLabel("js-panel-note-add"));uAdmin.tickets.created=true}if(uAdmin.tickets.isInit){return false}uAdmin.tickets.isInit=true;uAdmin.panel.changeAct(jQuery("#u-quickpanel #note").get(0));jQuery(document).one("mousedown",function(c){var d=new uAdmin.tickets.ticket({x:c.pageX,y:c.pageY,width:0,height:0,message:{authorName:uAdmin.tickets.user.fname+" "+uAdmin.tickets.user.lname,authorLogin:uAdmin.tickets.user.login,text:getLabel("js-ticket-empty")}});d.listen();uAdmin.panel.changeAct(jQuery("#u-quickpanel #note").get(0))})};a.prototype.swapVisible=function(){this.disabled?this.enable():this.disable()};a.prototype.disable=function(){var c=this;jQuery("div.u-ticket, div.u-ticket-comment, #u-quickpanel #note").hide();jQuery(document).unbind("keydown",c.bindEvents);jQuery("#u-quickpanel #note").unbind("click",c.bindEvents);c.disabled=true};a.prototype.enable=function(){var c=this;jQuery("div.u-ticket, div.u-ticket-comment, #u-quickpanel #note").show();jQuery(document).bind("keydown",c.bindEvents);jQuery("#u-quickpanel #note").bind("click",c.bindEvents);c.disabled=false};a.prototype.bindEvents=function(c){if((c.shiftKey&&(c.keyCode==67||c.keyCode==99)&&(c.target.nodeName!="INPUT"&&c.target.nodeName!="TEXTAREA"))||(c.type=="click"&&document.getElementById("note").id=="note")){uAdmin.tickets.initNewTicket()}};a.prototype.draw=function(f){uAdmin.tickets.user=f.user;var d;for(d in f.tickets.ticket){d=f.tickets.ticket[d];var g=d.position,e=d.author;var c=new this.ticket({id:d.id,x:g.x,y:g.y,width:g.width,height:g.height,message:{authorName:e.fname+" "+e.lname,authorLogin:e.login,text:d.message}});c.update()}};a.prototype.disabled=true;a.prototype.isInit=false;return b(a,this)});uAdmin(".eip",function(b){function a(){var d=this;jQuery(document).bind("keydown",function(k){if(k.keyCode==113){d.swapEditor()}});var e=(navigator.userAgent.indexOf("Mac OS")!=-1);var g=jQuery('\n			<div id="save_edit">\n				<div id="save" title="'+getLabel("js-panel-save")+" ("+(e?"Cmd":"Ctrl")+'+S)">&#160;</div>\n				<div id="edit_back" title="'+getLabel("js-panel-cancel")+" ("+(e?"Cmd":"Ctrl")+'+Z)">&#160;</div>\n				<div id="edit_next" title="'+getLabel("js-panel-repeat")+" ("+(e?"Cmd+Shift+Z":"Ctrl+Y")+')">&#160;</div>\n			</div>\n		').insertAfter("div#u-panel-holder div#u-quickpanel div#butterfly");var f=jQuery('\n			<div id="edit">\n				<span class="in_ico_bg">&#160;</span>\n				'+getLabel("js-panel-edit")+" (F2)			</div>\n		").insertAfter("div#u-panel-holder div#u-quickpanel div#butterfly");f.click(function(){d.swapEditor();return false});var h=jQuery('\n			<div id="meta">\n				<span class="in_ico_bg">&#160;</span>\n				'+getLabel("js-panel-meta")+"\n			</div>\n		").insertAfter("div#u-panel-holder div#u-quickpanel div#note");if(uAdmin.data&&uAdmin.data.pageId){d.meta.element_id=uAdmin.data.pageId;d.meta.old={alt_name:uAdmin.data.page["alt-name"],title:uAdmin.data.title,keywords:uAdmin.data.meta.keywords,descriptions:uAdmin.data.meta.description};d.meta["new"]={};var c=jQuery('\n				<div id="u-quickpanel-meta">\n					<table>\n						<tr>\n							<td width="100px">'+getLabel("js-panel-meta-altname")+': </td>\n							<td>\n								<input type="text" name="alt_name" id="u-quickpanel-metaaltname" value="'+d.meta.old.alt_name+'"/>\n								<div class="meta_count" id="u-quickpanel-metaaltname-count"/>\n							</td>\n						</tr>\n						<tr>\n							<td width="100px">'+getLabel("js-panel-meta-title")+': </td>\n							<td>\n								<input type="text" name="title" id="u-quickpanel-metatitle" value="'+d.meta.old.title+'"/>\n								<div class="meta_count" id="u-quickpanel-metatitle-count"/>\n							</td>\n						</tr>\n						<tr>\n							<td>'+getLabel("js-panel-meta-keywords")+': </td>\n							<td>\n								<input type="text" name="meta_keywords" id="u-quickpanel-metakeywords" value="'+d.meta.old.keywords+'"/>\n								<div class="meta_count" id="u-quickpanel-metakeywords-count"/>\n								<div class="meta_buttons"><a href="/admin/seo/" style="color:white;">'+getLabel("js-panel-meta-analysis")+"</a></div>\n							</td>\n						</tr>\n						<tr>\n							<td>"+getLabel("js-panel-meta-descriptions")+':</td>\n							<td>\n								<input type="text" name="meta_descriptions" id="u-quickpanel-metadescription" value="'+d.meta.old.descriptions+'"/>\n								<div class="meta_count" id="u-quickpanel-metadescription-count"/>\n								<div class="meta_buttons">\n									<input type="submit" id="save_meta_button" value="'+getLabel("js-panel-save")+'">\n								</div>\n							</td>\n						</tr>\n					</table>\n				</div>\n			').appendTo("div#u-panel-holder");h.click(function(){uAdmin.panel.changeAct(this);c.toggle();d.meta.enabled=c.css("display")!="none";return false});jQuery("#save_meta_button",c).click(function(){var l={},k;for(k in d.meta["new"]){if(d.meta["new"][k]!=d.meta.old[k]){l["field-name"]=((k=="keywords"||k=="descriptions")?"meta_"+k:k);l["element-id"]=d.meta.element_id;l.value=d.meta["new"][k];jQuery.post("/admin/content/editValue/save.json",l,function(m){if(m.error){d.message(m.error);return}},"json")}delete d.meta["new"][k]}return false});jQuery('input[type!="submit"]',c).bind("blur",function(l){var k=this.name.replace(/^meta_/g,"");d.meta["new"][k]=this.value}).bind("keyup mousedown blur",function(){var k=this.value.length;if(k>255){this.value=this.value.substring(0,255)}else{var m=this.id+"-count";jQuery("#"+m).html(k)}}).trigger("keyup")}else{h.remove()}jQuery("#save",g).click(function(){d.queue.save();return false});jQuery("#edit_back",g).click(function(){d.queue.back();return false});jQuery("#edit_next",g).click(function(){d.queue.forward();return false});d.bind("enable",function(k){if(k=="after"){uAdmin.panel.changeAct(f[0])}});d.bind("disable",function(k){if(k=="after"){uAdmin.panel.changeAct(f[0])}});d.bind("repaint",function(k){});d.bind("save",function(k){});jQuery(document).ready(function(){if(jQuery.cookie("eip-editor-state")){uAdmin.eip.swapEditor()}else{uAdmin.tickets.enable();uAdmin.panel.editInAdmin("enable")}});(function j(){var k=null;var l=function(){jQuery(".eip-del-button").remove()};jQuery(".u-eip-edit-box").live("mouseover",function(){jQuery(this).addClass("u-eip-edit-box-hover");var m=d.searchAttr(this);if(jQuery(this).attr("umi:delete")&&m.id){if(k){clearInterval(k)}l();var n=document.createElement("div");jQuery(n).attr("class","eip-del-button");document.body.appendChild(n);d.placeWith(this,n,"right","middle");jQuery(n).bind("mouseover",function(){if(k){clearInterval(k)}});jQuery(n).bind("mouseout",function(){k=setTimeout(l,500)});jQuery(n).bind("click",function(){m["delete"]=true;d.queue.add(m);uAdmin.eip.normalizeBoxes()})}else{l()}this.onclick=function(o){this.onclick=function(){return true};if(window.event){return window.event.ctrlKey}else{return o.ctrlKey}}});jQuery(".u-eip-edit-box-hover").live("mouseout",function(n){var m=jQuery(this);jQuery(this).removeClass("u-eip-edit-box-hover");if(m.attr("umi:delete")){k=setTimeout(l,500)}m.click(function(){return true})});window.onresize=function(){d.normalizeBoxes()}})()}a.prototype.swapEditor=function(){if(this.enabled){this.disable();jQuery("#u-quickpanel #edit").html('<span class="in_ico_bg">&#160;</span>'+getLabel("js-panel-edit")+" (F2)");jQuery("#on_edit_in_place").html(getLabel("js-on-eip"));uAdmin.tickets.enable();uAdmin.panel.editInAdmin("enable")}else{this.enable();jQuery("#u-quickpanel #edit").html('<span class="in_ico_bg">&#160;</span>'+getLabel("js-panel-view")+" (F2)");jQuery("#on_edit_in_place").html(getLabel("js-off-eip"));uAdmin.tickets.disable();uAdmin.panel.editInAdmin("disable")}this.bindEvents()};a.prototype.enable=function(){var c=this;c.onenable("before");c.finishLast();c.inspectDocument();c.highlight();c.normalizeBoxes();jQuery(window).load(function(){setTimeout(function(){c.normalizeBoxes()},250)});c.enabled=true;if(c.queue.current>=0){jQuery("#save").addClass("save_me")}var d=new Date();d.setTime(d.getTime()+(3*24*60*60*1000));jQuery.cookie("eip-editor-state","enabled",{path:"/",expires:d});c.message(getLabel("js-panel-message-edit-on"));jQuery(document).bind("keydown",c.bindHotkeys);c.onenable("after")};a.prototype.disable=function(){this.ondisable("before");this.finishLast();this.unhighlight();this.enabled=false;jQuery.cookie("eip-editor-state","",{path:"/",expires:0});jQuery("#save").removeClass("save_me");this.message(getLabel("js-panel-message-edit-off"));if(this.queue.current>=0){if(confirm(getLabel("js-panel-message-save-confirm"))){this.queue.save()}}jQuery(document).unbind("keydown",this.bindHotkeys);this.ondisable("after")};a.prototype.bind=function(d,g){var c=this,e=(typeof c["on"+d]=="function")?c["on"+d]:function(){};c["on"+d]=function(f){e(f);g(f)}};a.prototype.bindHotkeys=function(d){var c=uAdmin.eip.queue;if(navigator.userAgent.indexOf("Mac OS")!=-1){if(d.metaKey){switch(d.keyCode){case 83:c.save();break;case 90:if(d.shiftKey){c.forward()}else{c.back()}break;default:return true}return false}}else{if(d.ctrlKey){switch(d.keyCode){case 83:c.save();break;case 90:c.back();break;case 89:c.forward();break;default:return true}return false}}return true};a.prototype.finishLast=function(){if(this.previousEditBox){this.previousEditBox.finish(true);this.previousEditBox=null}};a.prototype.normalizeBoxes=function(){var c=this;jQuery(c.listNodes).each(function(h,l){if(!l.boxNode){return}var f=c.nodePositionInfo(l);jQuery(l.boxNode).css({width:f.width,height:f.height,left:f.x,top:f.y});var j=l.addButtonNode;var k="bottom",e="left";if(j){var g;if((g=jQuery(l).attr("umi:button-position"))){var d=g.split(/ /);if(d.length==2){k=d[0];e=d[1]}}c.placeWith(l,j,k,e)}});c.onrepaint("after")};a.prototype.bindEvents=function(){var d=this,c=jQuery(".u-eip-edit-box");c.die("click");c.die("drop");c.die("dragexit");c.die("dragover");c.unbind("click");c.unbind("drop");c.unbind("dragexit");c.unbind("dragover");var e="click";if(navigator.userAgent.toLowerCase().indexOf("firefox")||navigator.userAgent.toLowerCase().indexOf("chrome")){e=e+" drop";c.live("dragexit",function(f){f.stopPropagation();f.preventDefault()});c.live("dragover",function(f){f.stopPropagation();f.preventDefault()})}c.live(e,function(j){var h=j.target;if(j.ctrlKey||(navigator.userAgent.indexOf("Mac OS")!=-1&&j.metaKey)){if(this.tagName=="A"){location.href=this.href}return true}var g=(typeof h.onclick=="function")?h.onclick:function(){};var k=function(){return false};h.onclick=k;setTimeout(function(){if(h&&g!=k){h.onclick=g}},100);for(var f=0;f<25;f++){if(!h){return false}if(h.tagName!="TABLE"&&jQuery(h).attr("umi:field-name")){break}h=h.parentNode}if(!h){return false}j.stopPropagation();j.stopImmediatePropagation();j.preventDefault();d.edit(h,j.originalEvent.dataTransfer?j.originalEvent.dataTransfer.files:null);j.stopPropagation();j.stopImmediatePropagation();j.preventDefault();return false});window.onbeforeunload=function(){if(uAdmin.eip.queue.current>=0||uAdmin.eip.queue.save.count>0){return getLabel("js-panel-message-save-before-exit")}}};a.prototype.inspectDocument=function(){var c=this;c.editNodes=[];c.listNodes=[];var d=c.getRegions();d.each(function(e,f){if(jQuery(f).css("display")=="none"){return}c.inspectNode(f)})};a.prototype.inspectNode=function(c){if(c.tagName=="TABLE"){return}if(jQuery(c).attr("umi:field-name")){this.editNodes.push(c)}if(jQuery(c).attr("umi:module")){this.listNodes.push(c)}if(jQuery.browser.msie){jQuery(c).parents("a:first").each(function(){var d=this.href;jQuery(this).click(function(f){if(f.ctrlKey){window.location.href=d}});this.removeAttribute("href")})}};a.prototype.getRegions=function(){return jQuery("*[umi\\:field-name], *[umi\\:module]")};a.prototype.isParentOf=function(d,c){if(!c||!d){return false}if(c==d){return true}if(d.parentNode){return isParentOf(d.parentNode,c)}return false};a.prototype.highlight=function(d,c){var e=this;if(e.highlighted){e.unhighlight()}e.highlighted=true;jQuery(e.editNodes).each(function(f,g){if(e.isParentOf(g,d)==false){e.highlightNode(g)}});if(!c){jQuery(e.listNodes).each(function(f,g){if(e.isParentOf(g,d)==false){e.highlightListNode(g)}})}e.onrepaint("after");e.markInversedBoxes()};a.prototype.unhighlight=function(){jQuery(".u-eip-edit-box").each(function(d,e){e=jQuery(e);var f=e.attr("umi:empty");if(f&&(e.attr("tagName")!="IMG")&&(e.html()==f)){e.html("")}e.attr("title","")});var c=jQuery(".u-eip-edit-box");c.removeClass("u-eip-edit-box u-eip-edit-box-hover u-eip-modified u-eip-deleted u-eip-edit-box-inversed");c.unbind("click");c.unbind("mouseover");c.unbind("mouseout");c.unbind("mousedown");c.unbind("mouseup");jQuery(".u-eip-add-box, .u-eip-add-button, .u-eip-del-button").remove();jQuery(".u-eip-sortable").sortable("destroy");jQuery(".u-eip-sortable").removeClass("u-eip-sortable")};a.prototype.highlightNode=function(d){if(!jQuery(d).attr("umi:field-name")){return}var h=this.searchAttr(d);if(!h){return}var f=this.htmlTrim(jQuery(d).attr("umi:empty"));if(f&&this.htmlTrim(jQuery(d).html())==""&&(jQuery(d).attr("tagName")!="IMG")){try{jQuery(d).html(f)}catch(g){}jQuery(d).addClass("u-eip-empty-field")}jQuery(d).addClass("u-eip-edit-box");if(this.queue.search(h)){jQuery(d).addClass("u-eip-modified")}if(d.tagName=="A"||d.parentNode.tagName=="A"||jQuery("a",d).size()>0){var c=getLabel("js-panel-link-to-go");if(navigator.userAgent.indexOf("Mac OS")!=-1){c=c.replace(/Ctrl/g,"Cmd")}jQuery(d).attr("title",c);jQuery(d).bind("dblclick",function(){return false})}else{jQuery(d).attr("title","")}this.markInversedBoxes(jQuery(d))};a.prototype.searchAttr=function(d,h,c){if(!d){return false}var f;c=c||20;if(d.tagName=="BODY"||d.tagName=="TABLE"){return false}if(!this.searchAttr.info.node){this.searchAttr.info.node=d;var g=jQuery(d).attr("umi:field-name");if(!g&&typeof h!="function"){this.message("You should specify umi:field-name attribute");return false}if(!this.searchAttr.info.field_name){this.searchAttr.info.field_name=g}}var e=jQuery(d);if(typeof h!="function"||h(d)){if(e.attr("umi:element-id")){this.searchAttr.info.id=e.attr("umi:element-id");this.searchAttr.info.type="element";f=this.searchAttr.info;this.searchAttr.info={};return f}else{if(e.attr("umi:object-id")){this.searchAttr.info.id=e.attr("umi:object-id");this.searchAttr.info.type="object";f=this.searchAttr.info;this.searchAttr.info={};return f}}}if(d.parentNode){return this.searchAttr(d.parentNode,h,--c)}this.message("You should specify umi:element-id or umi:object attribute");return false};a.prototype.searchAttr.info={};a.prototype.searchRow=function(d,c){if(c){if(d.tagName=="BODY"||d.tagName=="TABLE"){return false}if(jQuery(d.parentNode).attr("umi:region")){return d.parentNode}else{return this.searchRow(d.parentNode,true)}}else{return jQuery("*[umi\\:region]",d).get(0)}};a.prototype.searchRowId=function(d){var c=jQuery(d).attr("umi:element-id");return c||(jQuery("*[umi\\:element-id]",d).length?jQuery("*[umi\\:element-id]",d).attr("umi:element-id"):null)};a.prototype.inlineAddPage=function(h){var q=this,n=q.searchRow(h);if(!n){q.message("Error, umi:region=row is not defined");return false}h=jQuery(h);var k={element:h.attr("umi:element-id"),object:h.attr("umi:object-id")},c=h.attr("umi:type-id");var p=false;jQuery(".u-eip-deleted").each(function(t,u){if(q.searchAttr(u).id==(k.element||k.object)){p=true;return}});if(p){q.message(getLabel("js-panel-message-cant-add"));return false}if(!c&&k.element){if(k.element.match(/^new/g)){var o=q.queue.search({id:k.element});c=o.type_id}else{var j=jQuery.ajax({url:"/admin/content/getTypeAdding/"+k.element+"/.json",async:false,dataType:"json"});j=JSON.parse(j.responseText);c=j.result}}if(!c){q.message("Error, umi:type-id is not defined");return false}var s=(h.attr("umi:method")=="lastlist"),e=jQuery(n).clone(),g=(s)?e.prependTo(n.parentNode):e.appendTo(n.parentNode);var l=function(v){var u,t;if(jQuery(v).attr("umi:field-name")){return v}else{if(v.children){for(t=0;t<v.children.length;t++){u=l(v.children[t]);if(u){return u}}}}return false};e=l(g.get(0));if(!e){q.message("Error, umi:field-name is not defined");return false}var f=q.searchAttr(e);f.id="new_"+new Date().getTime();f.type_id=c;f.add=true;f.node=g.get(0);if(k.object){f.parent=k.object;f.type="object"}if(k.element){f.parent=k.element;f.type="element"}delete f.field_name;if(jQuery(n).attr("umi:"+f.type+"-id")==""){jQuery(n).remove();jQuery(g).attr("umi:"+f.type+"-id",f.id);jQuery("*",g).each(function(t,u){if(!u.children.length){u.style.display=""}})}var m=function(t){var v="umi:"+f.type+"-id";if(jQuery(t).attr("tagName")=="TABLE"){return}if(jQuery(t).attr("umi:field-name")){var u=jQuery(t).attr("umi:empty");if(jQuery(t).attr("tagName")=="IMG"&&u){jQuery(t).attr("src",u)}else{jQuery(t).html(u?u:"")}jQuery(t).addClass("u-eip-empty-field");q.editNodes[q.editNodes.length]=t}if(jQuery(t).attr(v)){jQuery(t).attr(v,f.id)}};var r=jQuery('*[umi\\:region="row"]',g).get(0);jQuery('*[umi\\:region="row"]',g).remove();m(g);g.addClass("u-eip-newitem");var d=jQuery("*",g);d.each(function(t,u){q.inspectNode(u);q.highlightListNode(u);if(jQuery(u).attr("umi:region")){jQuery(u).html(r);jQuery("*",u).each(function(v,w){w=jQuery(w);if(!w.children().length){w.text("");w.css("display","none")}if(w.attr("href")){w.attr("href","")}if(w.attr("umi:"+f.type+"-id")){w.attr("umi:"+f.type+"-id","")}})}m(u)});q.queue.add(f);q.normalizeBoxes();return true};a.prototype.htmlTrim=function(c){c=jQuery.trim(c);return c.replace(/<br ?\/?>/g,"").replace(/<p><\/p>/g,"")};a.prototype.markInversedBoxes=function(c){setTimeout(function(){if(!c){c=jQuery(".u-eip-edit-box")}c.each(function(e,g){var d=new RGBColor(jQuery(g).css("color"));var f=d.toHash();var h=(f.red/255+f.green/255+f.blue/224)/3;if(h>=0.9){jQuery(g).addClass("u-eip-edit-box-inversed")}})},500)};a.prototype.highlightListNode=function(r){var o=this;if(!jQuery(r).attr("umi:module")){return false}var k=document.createElement("div");document.body.appendChild(k);r.boxNode=k;var u=o.nodePositionInfo(r);if(!u.x&&!u.y){return false}jQuery(k).attr("class","u-eip-add-box");jQuery(k).css({position:"absolute",width:u.width,height:u.height,left:u.x,top:u.y});var c=document.createElement("a");r.addButtonNode=c;jQuery(c).attr({"class":"u-eip-add-button"}).html(getLabel("js-panel-add"));jQuery(c).hover(function(){jQuery(this).addClass("u-eip-add-button-hover")},function(){jQuery(this).removeClass("u-eip-add-button-hover")});var h="bottom";var g="left";var m;if(m=jQuery(r).attr("umi:button-position")){var d=m.split(/ /);if(d.length==2){h=d[0];g=d[1]}}if(jQuery(r).attr("umi:add-method")!="none"){o.placeWith(r,c,h,g);var l=jQuery(r).attr("umi:element-id");var e=jQuery(r).attr("umi:module");var f=jQuery(r).attr("umi:method");jQuery(c).bind("mouseup",function(){var v=jQuery(r).attr("umi:region");var y=jQuery(r).attr("umi:add-method");var x=o.searchRow(r);if(x&&(v=="list")&&(y!="popup")){o.inlineAddPage(r)}else{if(o.queue.current>=0){o.message(getLabel("js-panel-message-save-first"));return}var w="/admin/content/eip_add_page/choose/"+parseInt(l)+"/"+e+"/"+f+"/";jQuery.ajax({url:w+".json",dataType:"json",success:function(z){if(z.data.error){uAdmin.eip.message(z.data.error);return}jQuery.openPopupLayer({name:"CreatePage",title:getLabel("js-eip-create-page"),url:w})},error:function(){uAdmin.eip.message(getLabel("error-require-more-permissions"));return}});jQuery.getJSON(w+".json",function(z){if(z.data.error){uAdmin.eip.message(z.data.error);return}jQuery.openPopupLayer({name:"CreatePage",title:getLabel("js-eip-create-page"),url:w})})}});jQuery(c).hover(function(){jQuery(k).addClass("u-eip-add-box-hover")},function(){jQuery(k).removeClass("u-eip-add-box-hover")});document.body.appendChild(c)}if(jQuery(r).attr("umi:sortable")=="sortable"){jQuery(r).addClass("u-eip-sortable");var t=null,j=null,s,n,q=false,p=[];jQuery("*").each(function(x,y){if(y.tagName=="TABLE"){return}if(jQuery(y).attr("umi:sortable")!="sortable"){return}if(jQuery(y).attr("umi:module")!=e){return}var w=false;jQuery(y).parents().each(function(A,z){if(z==r){w=true}});if(w){return}var v=false;jQuery("*",y).each(function(A,z){if(z==r){v=true}});if(v){return}p.push(y)});jQuery(r).sortable({items:'> *[umi\\:region="row"]',tolerance:"pointer",cursor:"move",dropOnEmpty:true,forcePlaceholderSize:true,placeholder:"u-eip-sortable-placeholder",connectWith:p,start:function(v,w){s=w.item[0];jQuery.getJSON("/admin/content/eip_move_page/"+jQuery(s).attr("umi:element-id")+"/.json?check",function(y){if(y.error){jQuery(r).sortable("cancel");uAdmin.eip.message(y.error);return}else{var x=s.nextSibling;do{if(!x){break}if(x.nodeType!=1){continue}if(o.searchRowId(x)){break}}while(x=x.nextSibling);t=x;n=o.searchAttr(s.parentNode,function(z){return jQuery(z).attr("umi:sortable")=="sortable"});j=s.parentNode;q=true}})},update:function(x,y){if(!q){return}else{q=false}var w=y.item[0];var v=w.nextSibling;do{if(!v){break}if(v.nodeType!=1){continue}if(o.searchRowId(v)){break}}while(v=v.nextSibling);var z=o.searchAttr(w.parentNode,function(B){return jQuery(B).attr("umi:sortable")=="sortable"});var A=parseInt(z?z.id:null);if(A==0||n.id==0){if(A!=n.id){return}}z.node=s;z.move=true;z.moved=o.searchRowId(w);z.next=v;z.old_next=t;z.parent_id=A;z.parent=w.parentNode;z.old_parent=j;delete z.field_name;t=null;j=null;o.normalizeBoxes();o.queue.add(z)}})}return k};a.prototype.nodePositionInfo=function(c){c=jQuery(c);return{width:c.innerWidth(),height:c.innerHeight(),x:c.offset().left,y:c.offset().top}};a.prototype.placeWith=function(c,d,n,h){if(!c||!d){return}var g=this.nodePositionInfo(c);var l=jQuery(d);var m,k;switch(n){case"top":k=g.y-parseInt(l.css("height"));break;case"right":m=g.x+g.width;break;case"left":m=g.x-l.width();break;default:k=g.y+g.height}if(n=="top"||n=="bottom"){switch(h){case"right":m=g.x+g.width-l.width();break;case"middle":case"center":if(g.width-parseInt(l.css("width"))>0){m=g.x+Math.ceil((g.width-l.width())/2)}else{m=g.x}break;default:m=g.x;m+=parseInt(jQuery(c).css("padding-left"))}}else{switch(h){case"top":k=g.y;break;case"bottom":k=g.y+g.height-parseInt(l.css("height"));break;default:if(g.height-parseInt(l.css("height"))>0){k=g.y+Math.ceil((g.height-parseInt(l.css("height")))/2)}else{k=g.y}}}var o=l.width()+m;var f=jQuery(window);if(o>f.width()){m=f.width()-l.width()-30}try{l.css({position:"absolute",left:m+"px",top:k+"px","z-index":560})}catch(j){}};a.prototype.applyStyles=function(e,g){var d=["font-size","font-family","font-name","margin-left","margin-right","margin-top","margin-bottom","font-weight"],c;e=jQuery(e);g=jQuery(g);for(c in d){var f=d[c];g.css(f,e.css(f))}g.width(e.outerWidth());g.height(e.outerHeight())};a.prototype.message=function(c){jQuery.jGrowl("<p>"+c+"</p>",{header:"UMI.CMS",life:10000})};a.prototype.edit=function(d,c){if(jQuery(d).hasClass("u-eip-deleted")||jQuery(d).parents().hasClass("u-eip-deleted")){this.message(getLabel("js-panel-message-cant-edit"));return false}this.finishLast();jQuery(".eip-del-button").remove();this.previousEditBox=this.editor.get(d,c);if(this.previousEditBox){jQuery(".u-eip-add-button, .u-eip-add-box").css("display","none")}jQuery(d).removeClass("u-eip-edit-box u-eip-edit-box-hover u-eip-modified u-eip-deleted u-eip-empty-field u-eip-edit-box-inversed");if(this.previousEditBox){jQuery(d).addClass("u-eip-editing")}var e=this.trim(jQuery(d).attr("umi:empty"));if(e&&this.trim(jQuery(d).html())==e){jQuery(d).html("&nbsp;");jQuery(d).removeClass("u-eip-empty-field")}return true};a.prototype.trim=function(c){c=jQuery.trim(c);return c.replace(/<br ?\/?>/g,"").replace(/<p><\/p>/g,"")};a.prototype.queue=[];a.prototype.queue.add=function(c){if(this.current==-1){jQuery("#save").addClass("save_me")}if(this.current<this.length-1){for(var d=this.length-1;d>this.current;d--){this.pop()}this.current=(this.length)}else{++this.current}this.push(c);this.step();if(c.add){uAdmin.eip.message(getLabel("js-panel-message-add-after-save"));jQuery(c.node).css("display","")}if(c.move){jQuery(c.node.parentNode).addClass("u-eip-modified")}if(c["delete"]){uAdmin.eip.message(getLabel("js-panel-message-delete-after-save"));jQuery(c.node).addClass("u-eip-deleted")}jQuery(c.node).addClass("u-eip-modified");return this.length};a.prototype.queue.get=function(c){if(!parseInt(c)){c=this.current}return this[c]||null};a.prototype.queue.search=function(c){var d=this.current;while(d>=0){if(this[d].id==c.id&&(this[d].field_name==c.field_name||this[d].add||this[d].move||this[d]["delete"])){return this[d]}--d}return false};a.prototype.queue.back=function(c){c=parseInt(c)||1;while(c--){if(this[this.current]){this.cancel()}}uAdmin.eip.normalizeBoxes();this.step()};a.prototype.queue.forward=function(c){c=parseInt(c)||1;while(c--){if(this[this.current+1]){this.apply()}}uAdmin.eip.normalizeBoxes();this.step()};a.prototype.queue.apply=function(){uAdmin.eip.finishLast();++this.current;var c=this.get();if(!c.add&&!c.move&&!c["delete"]&&!uAdmin.eip.editor.replace(c,c.new_value,c.old_value)){--this.current}else{switch(true){case c.add:uAdmin.eip.message(getLabel("js-panel-message-add-after-save"));jQuery(c.node).css("display","");break;case c["delete"]:uAdmin.eip.message(getLabel("js-panel-message-delete-after-save"));jQuery(c.node).addClass("u-eip-deleted");break;case c.move:if(c.next){jQuery(c.node).insertBefore(c.next)}else{jQuery(c.node).appendTo(c.parent)}jQuery(c.node).addClass("u-eip-modified");jQuery(c.parent).addClass("u-eip-modified");break;default:jQuery(c.node).addClass("u-eip-modified")}}if(this.current==0){jQuery("#save").addClass("save_me")}};a.prototype.queue.cancel=function(){uAdmin.eip.finishLast();var c=this.get();switch(true){case c.add:--this.current;jQuery(c.node).css("display","none");break;case c["delete"]:--this.current;jQuery(c.node).removeClass("u-eip-deleted");break;case c.move:--this.current;if(c.old_next){jQuery(c.node).insertBefore(c.old_next)}else{jQuery(c.node).appendTo(c.old_parent)}jQuery(c.node).removeClass("u-eip-modified");if(!this.search(c)){jQuery(c.parent).removeClass("u-eip-modified")}break;default:if(uAdmin.eip.editor.replace(c,c.old_value,c.new_value)){--this.current;jQuery(c.node).addClass("u-eip-modified")}}if(c.add||c.move||c["delete"]||uAdmin.eip.editor.replace(c,c.old_value,c.new_value)){if(!this.search(c)){jQuery(c.node).removeClass("u-eip-modified")}if(this.current==-1){jQuery("#save").removeClass("save_me");uAdmin.eip.message(getLabel("js-panel-message-changes-revert"))}}};a.prototype.queue.step=function(){if(this.length){jQuery("#u-quickpanel #save_edit #edit_back").attr("class",(this.current==-1)?"":"ac");jQuery("#u-quickpanel #save_edit #edit_next").attr("class",((this.length-this.current)==1)?"":"ac")}};a.prototype.queue.save=function(j){uAdmin.eip.finishLast();if(this.current==-1&&!j){return false}var c=this,g=false,k={},d=jQuery("div.popupText span",c.progress);switch(j){case"add":for(e in c.save.add){g=c.save.add[e];delete c.save.add[e];break}if(g){for(e in c.save.added){if(g.parent==e){g.parent=c.save.added[e]}}var f="/admin/content/eip_quick_add/"+g.parent+".json?type-id="+g.type_id;if(jQuery(g.node).attr("umi:module")!="data"){f+="&force-hierarchy=1"}jQuery.get(f,function(n){if(n.error){uAdmin.eip.message(n.error);return}var m=parseInt(n.data["element-id"]);var l=parseInt(n.data["object-id"]);c.save.added[g.id]=m||l;jQuery(g.node).removeClass("u-eip-newitem u-eip-modified");jQuery(g.node).attr("umi:"+g.type+"-id",m||l);jQuery("*[umi\\:"+g.type+'-id="'+g.id+'"]',g.node).attr("umi:"+g.type+"-id",m||l);g=false;uAdmin.eip.normalizeBoxes();d.text(parseInt(d.text())+1);--c.save.count;c.save("add")},"json")}else{c.save("move")}break;case"move":for(e in c.save.move){g=c.save.move[e];delete c.save.move[e];break}if(g){g.next=(g.next==null?"":uAdmin.eip.searchRowId(g.next));for(e in c.save.added){if(g.parent_id==e){g.parent_id=c.save.added[e]}if(g.moved==e){g.moved=c.save.added[e]}if(g.next==e){g.next=c.save.added[e]}}jQuery.post("/admin/content/eip_move_page/"+g.moved+"/"+g.next+".json",{"parent-id":g.parent_id},function(l){if(l.error){uAdmin.eip.message(l.error);return}jQuery(g.node).removeClass("u-eip-modified");jQuery(g.node).parent().removeClass("u-eip-modified");uAdmin.eip.message(getLabel("js-panel-message-page-moved"));--c.save.count;d.text(parseInt(d.text())+1);c.save("move")},"json")}else{c.save("edit")}break;case"edit":for(e in c.save.edit){g=c.save.edit[e];delete c.save.edit[e];break}if(g){for(e in c.save.added){if(g.id==e){g.id=c.save.added[e]}}if(uAdmin.eip.editor.equals(g.new_value,g.old_value)){jQuery(g.node).removeClass("u-eip-modified");g=false;uAdmin.eip.normalizeBoxes();d.text(parseInt(d.text())+1);--c.save.count;c.save("edit")}else{k={};k[g.type+"-id"]=g.id;k.qt=new Date().getTime();k["field-name"]=g.field_name;var h,e;switch(typeof g.new_value){case"object":if(g.new_value.src){h=g.new_value.src}else{h=[];for(e in g.new_value){h.push(e)}}break;case"string":if(jQuery.browser.mozilla&&g.new_value.match(/="\.\.\//g)){g.new_value=g.new_value.replace(/="[\.\.\/]+/g,'="/')}h=g.new_value.replace(/\sumi:[-a-z]+="[^"]*"/g,"");break;default:h=g.new_value}k.value=h;jQuery.post("/admin/content/editValue/save.json",k,function(m){if(m.error){uAdmin.eip.message(m.error);return}var l=m.property["new-link"];if(m.property["old-link"]&&l){if(g.node.tagName=="A"){g.node.href=l;jQuery(g.node).bind("click mouseup mousedown",function(){return true})}jQuery("a",g).each(function(o,p){p.href=l;jQuery(p).bind("click mouseup mousedown",function(){return true})})}jQuery(g.node).removeClass("u-eip-modified");g=false;uAdmin.eip.normalizeBoxes();d.text(parseInt(d.text())+1);--c.save.count;c.save("edit")},"json")}}else{c.save("del")}break;case"del":for(e in c.save.del){g=c.save.del[e];delete c.save.del[e];break}if(g){k={};k[g.type+"-id"]=g.id;k.qt=new Date().getTime();jQuery.post("/admin/content/eip_del_page.json",k,function(m){if(m.error){uAdmin.eip.message(m.error)}else{var l=uAdmin.eip.searchRow(g.node,true);if(l){jQuery(l).remove()}else{jQuery(g.node).remove()}g=false;uAdmin.eip.normalizeBoxes();d.text(parseInt(d.text())+1);--c.save.count;c.save("del")}},"json")}else{c.save.add={};c.save.added={};c.save.move={};c.save.edit={};c.save.del={};jQuery("#u-quickpanel #save_edit div").attr("class","");uAdmin.eip.message(getLabel("js-panel-message-changes-saved"));uAdmin.eip.onsave("after")}break;default:uAdmin.eip.onsave("before");while(0<=this.current){if(c[0].add){c.save.add[c[0].id]=c[0];++c.save.count}else{if(this[0].move){if(c.save.move[c[0].moved]){delete c.save.move[c[0].moved];--c.save.count}c.save.move[c[0].moved]=c[0];++c.save.count}else{if(this[0]["delete"]){c.save.del[c[0].id]=c[0];++c.save.count}else{if(c.save.edit[c[0].id+"_"+c[0].field_name]){c.save.edit[c[0].id+"_"+c[0].field_name].new_value=c[0].new_value}else{c.save.edit[c[0].id+"_"+c[0].field_name]=c[0];++c.save.count}}}}c.shift();--c.current}c.progress=jQuery.openPopupLayer({name:"SaveProgress",width:400,height:200,data:'\n						<div class="eip_win_head popupHeader">\n							<div class="eip_win_close popupClose">&#160;</div>\n							<div class="eip_win_title">Идёт сохранение</div>\n						</div>\n						<div class="eip_win_body popupBody">\n							<div class="popupText">Сохранено <span>0</span> изменений из '+c.save.count+'.</div>\n							<div class="eip_buttons">\n								<input type="button" class="primary ok" value="OK" />\n								<div style="clear: both;" />\n							</div>\n						</div>\n					'}).find("#popupLayer_SaveProgress");jQuery("input:button",c.progress).click(function(){jQuery.closePopupLayer("SaveProgress")});c.save("add")}return false};a.prototype.queue.save.add={};a.prototype.queue.save.added={};a.prototype.queue.save.move={};a.prototype.queue.save.edit={};a.prototype.queue.save.del={};a.prototype.queue.save.count=0;a.prototype.queue.current=-1;a.prototype.enabled=false;a.prototype.previousEditBox=null;a.prototype.editNodes=[];a.prototype.listNodes=[];a.prototype.meta={};return b(a,this)});uAdmin(".editor",function(b){function a(){}a.prototype.get=function(d,c){var e=uAdmin.eip.searchAttr(d);if(e){this.info=e;this.files=c;return this.load()}return false};a.prototype.load=function(){var c=this,f,j,e,h,g,d=uAdmin.eip.queue.search(c.info);if(d){if(d.add){if(c.info.field_name=="name"){c.info.field_type="string"}else{f=jQuery.ajax({url:"/utype/"+d.type_id+".json",async:false,dataType:"json"});f=JSON.parse(f.responseText);for(h in f.type.fieldgroups.group){h=f.type.fieldgroups.group[h];for(g in h.field){g=h.field[g];if(g.name==c.info.field_name){c.info.field_type=g.type["data-type"];break}}if(c.info.field_type){break}}}c.info.old_value=jQuery(c.info.node).attr("umi:empty");return c.draw(c.info.field_type)}c.info.old_value=d.new_value;c.info.field_type=d.field_type;c.info.params=d.params;c.info.node=d.node;if(c.info.field_type=="relation"){c.info.guide_id=d.guide_id;c.info.multiple=d.multiple;c.info["public"]=d["public"]}return c.draw(d.field_type)}j={};j[c.info.type+"-id"]=c.info.id;j["field-name"]=c.info.field_name;j.qt=new Date().getTime();f=jQuery.ajax({url:"/admin/content/editValue/load.json",async:false,data:j,type:"POST",dataType:"json"});f=JSON.parse(f.responseText);if(f.error){uAdmin.eip.message(f.error);return false}if(f.user&&f.user.type=="guest"){uAdmin.eip.message(getLabel("error-auth-required"));uAdmin.eip.closeMessages();uAdmin.session.sessionCloseMessage(true);return false}c.info.old_value={};switch(f.property.type){case"relation":for(e in f.property.item){c.info.old_value[f.property.item[e].id]=f.property.item[e].name}c.info.guide_id=f.property["guide-id"];c.info.multiple=(f.property.multiple=="multiple");c.info["public"]=(f.property["public"]=="public");break;case"symlink":for(e in f.property.page){c.info.old_value[f.property.page[e].id]=f.property.page[e].name}break;default:c.info.old_value=f.property.value}c.info.field_type=f.property.type;return c.draw(f.property.type)};a.prototype.bindFinishEvent=function(){var c=this;jQuery(document).bind("click",function(h){if(!uAdmin.eip.enabled){return}if(jQuery(h.target).attr("contentEditable")=="true"){return}if(jQuery(h.target).attr("class")=="eip-ui-element"){return}if(jQuery(h.target).attr("class")=="ui-datepicker"){return}if(jQuery(h.target).attr("class")=="symlink-item-delete"){return}if(jQuery(h.target).parents(".eip-ui-element, .ui-datepicker, .ui-datepicker-title, .ui-datepicker-header, .ui-datepicker-calendar").size()){return}var d=jQuery(h.target).parents();for(var g=0;g<d.size();g++){var f=d[g];if(f.tagName=="TABLE"){continue}if(f.tagName=="BODY"){break}if(jQuery(f).attr("class")=="symlink-item-delete"){return}if(jQuery(f).attr("contentEditable")=="true"){return}if(jQuery(f).attr("class")&&jQuery(f).attr("class").indexOf("mceEditor")!=-1){return}}c.finish(true)})};a.prototype.draw=function(d){var c=this;if(typeof c.draw[d]=="function"){return c.draw[d](c)}uAdmin.eip.message('Unkown field type "'+d+'"');return false};a.prototype.draw["boolean"]=function(d){var c=uAdmin.eip.nodePositionInfo(d.info.node);if(typeof d.info.old_value!="boolean"){d.info.old_value=!!d.info.old_value}if(d.info.node.tagName=="INPUT"&&d.info.node.type=="checkbox"){setTimeout(function(){d.info.new_value=!d.info.old_value;d.info.node.checked=d.info.new_value;d.commit();d.cleanup()},300);return d}var e=document.createElement("input");e.type="checkbox";document.body.appendChild(e);d.finish=function(f){if(f){d.info.new_value=!d.info.old_value;jQuery(d.info.node).text(d.info.new_value?"Да":"Нет");d.commit()}jQuery(e).remove();d.info.node.style.visibility="visible";d.cleanup()};e.checked=!!d.info.old_value;jQuery(e).attr("class","eip-ui-element eip-ui-boolean");jQuery(e).css({position:"absolute",left:c.x,top:c.y,"z-index":1100});uAdmin.eip.applyStyles(d.info.node,e);d.info.node.style.visibility="hidden";jQuery(e).click(function(){d.finish(true)});return d};a.prototype.draw["int"]=function(c){return c.draw.text(c)};a.prototype.draw["float"]=function(c){return c.draw.text(c)};a.prototype.draw.counter=function(c){return c.draw.text(c)};a.prototype.draw.price=function(c){return c.draw.text(c)};a.prototype.draw.string=function(c){return c.draw.text(c)};a.prototype.draw.tags=function(c){return c.draw.text(c)};a.prototype.draw.text=function(c,k){var f=jQuery(c.info.node),g=f.html();if(k){c.info.old_value=c.info.old_value.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"')}f.html(c.info.old_value||"&nbsp;");f.attr("contentEditable",true);f.blur().focus();c.finish=function(l){c.finish=function(){};jQuery(document).unbind("keyup");jQuery(document).unbind("click");f.attr("contentEditable",false);jQuery(".u-eip-sortable").sortable("enable");if(l){if(!k&&c.info.field_type!="wysiwyg"){var n=f.html();if(n.match(/\s<br>$/g)){n=n.replace(/<br>$/g,"")}var m=n;n=n.replace(/<!--[\w\W\n]*?-->/mig,"");n=n.replace(/<style[^>]*>[\w\W\n]*?<\/style>/mig,"");n=n.replace(/<([^>]+)>/mg,"");n=n.replace(/(\t|\n)/gi," ");n=n.replace(/[\s]{2,}/gi," ");if(jQuery.browser.safari){n=n.replace(/\bVersion:\d+\.\d+\s+StartHTML:\d+\s+EndHTML:\d+\s+StartFragment:\d+\s+EndFragment:\d+\s*\b/gi,"")}if(n!=m){f.html(n)}}c.info.new_value=f.html();if(c.info.new_value==" "||c.info.new_value=="&nbsp;"||c.info.new_value=="<p>&nbsp;</p>"){c.info.new_value="";f.html(c.info.new_value)}if(c.info.field_type!="wysiwyg"&&c.info.field_type!="text"){c.info.new_value=jQuery.trim(c.info.new_value);if(c.info.new_value.substr(-4,4)=="<br>"){c.info.new_value=c.info.new_value.substr(0,c.info.new_value.length-4)}}else{c.info.new_value=c.info.new_value.replace(/%[A-z0-9_]+(?:%20)+[A-z0-9_]+%28[A-z0-9%]*%29%/gi,unescape)}switch(c.info.field_type){case"int":case"float":case"price":case"counter":c.info.new_value=parseFloat(c.info.new_value);break}c.commit()}else{f.html(g)}c.cleanup()};c.bindFinishEvent();var e=f.width(),j=f.height(),h=null;jQuery(".u-eip-sortable").sortable("disable");f.focus();var d=null;jQuery(document).bind("keyup",function(l){if(e!=f.width()||j!=f.height()){e=f.width();j=f.height();if(h){clearTimeout(h)}h=setTimeout(function(){uAdmin.eip.normalizeBoxes();h=null},1000)}if(l.keyCode==46){if(d==f.html().length){if(d==1){f.html("")}}}}).bind("keydown",function(l){if(l.keyCode==46){d=f.html().length}if(l.keyCode==13&&c.info.field_type!="wysiwyg"&&c.info.field_type!="text"){c.finish(true);return false}if(l.keyCode==27){c.finish(false);return false}return true});return c};a.prototype.draw.wysiwyg=function(l){var g=jQuery(l.info.node),c=false,f=false,d=false,j=false,e=function(m){m=m.replace(/<![\s\S]*?--[ \t\n\r]*>/ig," ");m=m.replace(/<!--.*?-->/ig," ");if(jQuery.browser.mozilla){m=m.replace(/<\/?(style|font|title).*[^>]*>/ig,"")}m=m.replace(/<\/?(title|style|font|meta)\s*[^>]*>/ig,"");m=m.replace(/\s*mso-[^:]+:[^;""]+;?/ig,"");m=m.replace(/<\/?o:[^>]*\/?>/ig,"");m=m.replace(/ style=['"]?[^'"]*['"]?/ig,"");m=m.replace(/ class=['"]?[^'">]*['"]?/ig,"");m=m.replace(/<span\s*[^>]*>\s*&nbsp;\s*<\/span>/ig," ");m=m.replace(/<span\s*[^>]*>/ig,"");m=m.replace(/<\/span\s*[^>]*>/ig,"");m=m.replace(/<\/(b|i|s|u|strong|center)>[\t\n]*<\1[^>]*>/gi,"");m=m.replace(/<\/(b|i|s|u|strong|center)>\s*<\1[^>]*>/gi," ");m=m.replace(/<(b|i|s|u|strong|center)[^>]*>[\s\t\n\xC2\xA0]*<\/\1>/gi,"");m=m.replace(/(\t|\n)/gi," ");m=m.replace(/[\s]{2,}/gi," ");if(jQuery.browser.safari){m=m.replace(/\bVersion:\d+\.\d+\s+StartHTML:\d+\s+EndHTML:\d+\s+StartFragment:\d+\s+EndFragment:\d+\s*\b/gi,"")}return m};l.draw.text(l,true);jQuery(document).bind("keyup",function(n){if((n.keyCode==86||c)||(n.keyCode==45&&f)){var m=e(g.html());if(m!=g.html()){g.html(m)}if(c&&!n.ctrlKey){c=false}if(f&&!n.shiftKey){f=false}}switch(n.keyCode){case 16:if(!j){f=false}break;case 17:if(!d){c=false}break;case 45:j=false;break;case 86:d=false;break}}).bind("keydown",function(m){switch(m.keyCode){case 16:f=true;break;case 17:c=true;break;case 45:j=true;break;case 86:d=true;break}});var h=uAdmin.wysiwyg.init(l.info.node);var k=l.finish;l.finish=function(m){h.destroy();k(m);uAdmin.eip.bindEvents()};return l};a.prototype.draw.file=function(l,e){var c="./images/cms/data/",g="",d,h,f;l.finish=function(m){if(m){if(l.info.node.tagName=="IMG"){l.info.node.src=l.info.new_value.src}else{l.info.node.style.backgroundImage="url("+l.info.new_value.src+")"}l.commit()}l.cleanup()};if(l.info.old_value){g=l.info.old_value.src.split(/\//g).pop();c="."+l.info.old_value.src.substr(0,l.info.old_value.src.length-g.length-1)}if(l.files&&l.files.length){d=l.files[0];d.folder=c;if(l.info.old_value){d.file=l.info.old_value.src}if(e){d.image=1}h=jQuery.ajax({url:"/admin/data/uploadfile/",async:false,data:d,type:"POST",dataType:"json"});h=JSON.parse(h.responseText);if(h.file.path){l.new_value=h.file.path;l.finish(true)}else{l.finish()}}else{f={folder:c,file:l.info.old_value.src};h=jQuery.ajax({url:"/admin/data/get_filemanager_info/",async:false,data:f,type:"POST",dataType:"json"});h=JSON.parse(h.responseText);var j="folder="+c;if(l.info.old_value){j+="&file="+l.info.old_value.src}if(e){j+="&image=1"}var k={flash:{height:460,url:"/styles/common/other/filebrowser/umifilebrowser.html?"+j},elfinder:{height:530,url:"/styles/common/other/elfinder/umifilebrowser.html?"+j+"&lang="+h.lang+"&file_hash="+h.file_hash+"&folder_hash="+h.folder_hash}};jQuery.openPopupLayer({name:"Filemanager",title:getLabel("js-file-manager"),width:660,height:k[h.filemanager].height,url:k[h.filemanager].url,afterClose:function(m){if(m){if(typeof m=="object"){m=m[0]}l.info.new_value=m?{src:m.toString()}:"";l.finish(true)}else{l.finish()}}});if(h.filemanager=="elfinder"){jQuery("#popupLayer_Filemanager .popupBody").append('\n					<div id="watermark_wrapper">\n						<label for="add_watermark">'+getLabel("js-water-mark")+'</label>\n						<input type="checkbox" name="add_watermark" id="add_watermark">\n					</div>\n				')}}return l};a.prototype.draw.img_file=function(c){return c.draw.file(c,true)};a.prototype.draw.video_file=function(c){return c.draw.file(c)};a.prototype.draw.date=function(d){var e=d.info.old_value;Date.prototype.getFormattedDate=function(j){var p=function(q){return(q>=10)?q:"0"+q};var m=this.getFullYear();var k=p(this.getMonth()+1);var n=p(this.getDate());var o=p(this.getHours());var h=p(this.getMinutes());var g=/NaN/;if(j){if((g.exec(m)!=null)||(g.exec(k)!=null)||(g.exec(n)!=null)||(g.exec(o)!=null)||(g.exec(h)!=null)){var l=new Date();return p(l.getDate())+"."+p(l.getMonth()+1)+"."+l.getFullYear()+" "+p(l.getHours())+":"+p(l.getMinutes())}return m+"-"+k+"-"+n+" "+o+":"+h}else{if((g.exec(o)!=null)||(g.exec(h)!=null)){var l=new Date();return p(l.getHours())+":"+p(l.getMinutes())}return o+":"+h}};if(e){if(e.match(/\d{4}-/g)){e=new Date(e.replace(/(\d{4})-(\d{2})-(\d{2})\s(\d{2}):(\d{2})/g,"$2 $3 $1 $4:$5"))}else{e=new Date(e.replace(/(\d{2})\.(\d{2})\.(\d{4})\s(\d{2}):(\d{2})/g,"$2 $1 $3 $4:$5"))}}if(!e){e=new Date}if(d.info.old_value){d.info.old_value=e.getFormattedDate(true)}d.draw.text(d);var c=uAdmin.eip.nodePositionInfo(d.info.node);var f=jQuery("#u-datepicker-input");if(!f.size()){f=document.createElement("input");f.id="u-datepicker-input";document.body.appendChild(f)}d.finish=function(g){jQuery(f).datepicker("destroy");jQuery(".ui-datepicker-trigger").remove();if(!d.info.new_value){d.info.new_value=jQuery(d.info.node).html()}d.cleanup();d.commit()};jQuery(f).css({position:"absolute",left:(c.x+c.width+5),top:(c.y),width:"1",height:"1",visibility:"hidden","font-size":"62.5%","z-index":560});jQuery(f).datepicker(jQuery.extend({showOn:"button",buttonImage:"/styles/common/other/calendar/icons_calendar_buttrefly_eip.png",buttonImageOnly:true,dateFormat:"yy-mm-dd",defaultDate:e,onSelect:function(g){d.info.new_value=g+" "+e.getFormattedDate(false);jQuery(d.info.node).html(d.info.new_value);jQuery(d.info.node).focus()}},jQuery.datepicker.regional[uAdmin.data.lang]));jQuery(d.info.node).html(d.info.old_value||e.getFormattedDate(true));uAdmin.eip.placeWith(d.info.node,jQuery(".ui-datepicker-trigger"),"right","middle");if(d.id==""){d.info.old_value=""}return d};a.prototype.draw.relation=function(m){jQuery(document).one("mouseup",function(){setTimeout(function(){m.bindFinishEvent()},100)});setTimeout(function(){jQuery(document).die("mouseup");m.bindFinishEvent()},1000);var f=uAdmin.eip.nodePositionInfo(m.info.node);var l=document.createElement("select");var k=document.createElement("input");document.body.appendChild(l);if(m.info.guide_id&&m.info["public"]){var g=document.createElement("input");g.type="button";g.value=" ";g.id="relationButton"+m.info.guide_id;g.className="relationAddButton";document.body.appendChild(g)}jQuery(l).attr("class","eip-ui-element");jQuery(l).css({position:"absolute",left:f.x,top:f.y,"z-index":1100});uAdmin.eip.applyStyles(m.info.node,l);jQuery(m.info.node).css("visibility","hidden");if(m.info.multiple){jQuery(l).attr("multiple","multiple");jQuery(l).attr("size",3)}var d;for(d in m.info.old_value){var e=document.createElement("option");jQuery(e).attr("value",d);jQuery(e).attr("selected","selected");jQuery(e).html(m.info.old_value[d]);l.appendChild(e)}jQuery(l).focus();jQuery(l).attr("name","rel_input");jQuery(l).attr("id","relationSelect"+m.info.guide_id);document.body.appendChild(k);uAdmin.eip.applyStyles(m.info.node,k);jQuery(k).attr({id:"relationInput"+m.info.guide_id,"class":"eip-ui-element",name:"rel_input_new"});if(typeof relationControl=="undefined"){jQuery('<script src="/styles/common/js/relation.control.js" type="text/javascript" charset="utf-8"><\/script>').appendTo("head")}var c=new relationControl(m.info.guide_id,null,true,"/admin/data/guide_items_all/");m.finish=function(){var o=[];m.info.new_value=c.getValue();m.commit();for(var n in m.info.new_value){o.push(m.info.new_value[n])}m.info.node.innerHTML=o.join(", ");m.info.node.style.visibility="visible";jQuery(l).resizable("destroy");jQuery(l).remove();jQuery(k).remove();jQuery(g).remove();jQuery("#u-ep-search-trigger").remove();m.cleanup()};c.loadItemsAll();if(m.info.multiple){var j=jQuery(l).height(),h=350;if(j<150){j=75;jQuery(l).css("height",j)}jQuery(l).resizable({minWidth:jQuery(l).width(),maxWidth:jQuery(l).width(),minHeight:j,maxHeight:h});jQuery(".ui-wrapper").css("z-index","1100")}jQuery(k).css({position:"absolute",width:jQuery(l).width(),left:f.x,top:(f.y+jQuery(l).height()+5),"z-index":1111});jQuery(g).css({position:"absolute",left:(f.x+jQuery(k).width()+5),top:(f.y+jQuery(l).height()+Math.round((jQuery(k).height()-jQuery(g).height())/2)),"z-index":1112});return m};a.prototype.draw.symlink=function(e){jQuery(document).one("mouseup",function(){setTimeout(function(){e.bindFinishEvent()},100)});setTimeout(function(){jQuery(document).die("mouseup");e.bindFinishEvent()},1000);var d=jQuery(e.info.node).attr("umi:type")?jQuery(e.info.node).attr("umi:type").split("::"):[];var c=uAdmin.eip.nodePositionInfo(e.info.node);var h=jQuery('<div><div id="symlinkInput'+e.info.id+'" /></div>').attr({"class":"eip-ui-element"}).css({position:"absolute",left:c.x,top:c.y,"z-index":1100}).appendTo("body");if(typeof symlinkControl=="undefined"){jQuery('<script src="/styles/common/js/symlink.control.js" type="text/javascript" charset="utf-8"><\/script>').appendTo("head")}var g=new symlinkControl(e.info.id,(d[0]||null),d,{inputName:e.info.field_name+"[]",fadeColorStart:[255,255,225],fadeColorEnd:[255,255,255]});for(var f in e.info.old_value){g.addItem(f,e.info.old_value[f],d,"")}uAdmin.eip.applyStyles(e.info.node,h[0]);jQuery("div input:text",h).css({width:h.width()-20});jQuery("div img.treeButton",h).css({bottom:"-4px","margin-left":"2px",position:"relative","background-color":"white",cursor:"pointer"});jQuery(e.info.node).css("visibility","hidden");e.finish=function(){var j=jQuery('input[name="'+e.info.field_name+'[]"]'),k=[];jQuery(e.info.node).css("visibility","visible");e.info.new_value={};for(f=0;f<j.length;f++){if(j[f].value){e.info.new_value[j[f].value]=jQuery("ul li span",h)[f-1].innerHTML;k.push(e.info.new_value[j[f].value])}}e.info.node.innerHTML=k.join(", ");e.commit();h.resizable("destroy");h.remove();jQuery("div.symlinkAutosuggest").remove();jQuery("#u-ep-search-trigger").remove();e.cleanup()};g.loadItems();return e};a.prototype.replace=function(e,d,c){return e?this.replace[e.field_type](e,d,c):false};a.prototype.replace.img_file=function(f,q,o){var l=false,g=jQuery(f.node),m,k,j;var e=function(u,t){return u==t};var d=function(t){if(t.indexOf("/images/cms/thumbs/")>=0){return true}if(t.indexOf("/images/autothumbs/")>=0){return true}return false};var s=function(z,x,t){z=z.toString();var v=z.split(/\./g);if(v.length<2){return false}var w=v[v.length-1].toString();v=v[v.length-2].toString().split(/\//g);var u=v[v.length-1].toString();var y=z.substr(0,z.length-u.length-w.length-1);return"/images/autothumbs"+y+u+"_"+x+"_"+t+"."+w};if(f.node.tagName=="IMG"){if(e(g.attr("src"),o.src||"")){f.node.src=q.src||"";l=true}else{if(d(f.node.src)){var c=g.width();var r=g.height();var p=f.node.src;if(p.indexOf(c)!=-1&&p.indexOf(r)==-1){r="auto"}if(p.indexOf(c)==-1&&p.indexOf(r)!=-1){c="auto"}f.node.src=s(q.src,c,r);l=true}}g.one("load",function(){uAdmin.eip.normalizeBoxes()})}var n=f.node.style.backgroundImage.replace(/"/g,"");if(n.substr(0,4)!="url("){if(!l&&g.attr("childNodes")){m=g.attr("childNodes");for(j=0;j<m.length;j++){k=m.item(j);if(k&&jQuery(k).attr("tagName")){replaceImage(jQuery(k),q.src,o.src)}}}return l}n=n.substring(4,n.length-1);var h=window.location.protocol+"//"+window.location.host;if(n.substr(0,h.length)==h){n=n.substr(h.length)}if(!n){return l}if(e(n,o.src)){f.node.style.backgroundImage="url("+q.src+")";l=true}if(!l&&g.attr("childNodes")){m=g.attr("childNodes");for(j=0;j<m.length;j++){k=m.item(j);if(k&&jQuery(k).attr("tagName")){replaceImage(jQuery(k),q.src,o.src)}}}return l};a.prototype.replace.video_file=function(f,d,c){var e=function(g){return(navigator.appName.indexOf("Microsoft")!=-1)?window[g]:document[g]};e("UmiVideoPlayer").setVideoFile(d);return true};a.prototype.replace["boolean"]=function(e,d,c){if(e.node.tagName=="INPUT"&&e.node.type=="checkbox"){e.node.checked=d?true:false}else{jQuery(e.node).html(d?"Да":"Нет")}return true};a.prototype.replace.relation=function(g,f,c){var e=[],d;for(d in f){e.push(f[d])}jQuery(g.node).html(e.join(", "));return true};a.prototype.replace.symlink=function(g,f,c){var e="",d;for(d in f){e+="<span>"+f[d]+"</span><br />"}jQuery(g.node).html(e);return true};a.prototype.replace["int"]=function(e,d,c){return this.text(e,d,c)};a.prototype.replace["float"]=function(e,d,c){return this.text(e,d,c)};a.prototype.replace.counter=function(e,d,c){return this.text(e,d,c)};a.prototype.replace.price=function(e,d,c){return this.text(e,d,c)};a.prototype.replace.string=function(e,d,c){return jQuery(e.node).html(d)};a.prototype.replace.tags=function(e,d,c){return this.text(e,d,c)};a.prototype.replace.text=function(e,d,c){return jQuery(e.node).html(d)};a.prototype.replace.wysiwyg=function(e,d,c){return jQuery(e.node).html(d||"&nbsp;")};a.prototype.replace.file=function(e,d,c){return this.text(e,d,c)};a.prototype.replace.date=function(e,d,c){return this.text(e,d,c)};a.prototype.commit=function(){var d=this.info.new_value,c=this.info.old_value;if(this.info.field_type.match(/file/)){d=this.info.new_value.src;c=this.info.old_value.src}if(!this.equals(d,c)){jQuery(this.info.node).addClass("u-eip-modified");uAdmin.eip.queue.add(this.info)}else{if(uAdmin.eip.queue.search(this.info)){jQuery(this.info.node).addClass("u-eip-modified")}}};a.prototype.cleanup=function(){uAdmin.eip.bindEvents();this.finish=function(){this.cleanup()};uAdmin.eip.highlightNode(this.info.node);jQuery(".u-eip-add-button").css("display","block");uAdmin.eip.normalizeBoxes();this.info.node.blur();jQuery(this.info.node).removeClass("u-eip-editing")};a.prototype.finish=function(){this.cleanup()};a.prototype.equals=function(){var d=false,c=arguments,g=Object.prototype.toString,f,e={length:0};switch(true){case (c.length!==2):break;case (typeof c[0]!==typeof c[1]):break;case (g.call(c[0])!==g.call(c[1])):break;default:switch(typeof c[0]){case"undefined":break;case"object":if(g.call(c[0])=="[object Array]"){d=(c[0].length===c[1].length);if(d){for(f=0;f<c[0].length;f++){e[c[0][f]]=f;++e.length}for(f=0;f<c[1].length;f++){if(delete e[c[0][f]]){--e.length}}if(e.length===0){d=true}}}else{for(f in c[0]){e[f]=f;++e.length}for(f in c[1]){if(delete e[f]){--e.length}}if(e.length===0){d=true}if(d){for(f in c[0]){d=this.equals(c[0][f],c[1][f]);if(!d){break}}}}break;default:d=(c[0]===c[1])}}return d};return b(a,this)},"eip");uAdmin(".wysiwyg",function(b){function a(){this.settings=jQuery.extend(this[this.type].settings,this.settings);this[this.type]();this.init=this[this.type].init}a.prototype.init=function(){return false};a.prototype.settings=function(){return false};a.prototype.inline=function(){jQuery('<script src="/js/cms/wysiwyg/inline/inlineWYSIWYG.js" type="text/javascript" charset="utf-8"><\/script>').appendTo("head")};a.prototype.inline.init=function(c){return new inlineWYSIWYG(c)};a.prototype.tinymce=function(){window.tinyMCEPreInit={suffix:"_src",base:"/js/cms/wysiwyg/tinymce/jscripts/tiny_mce"};jQuery('<script src="/js/cms/wysiwyg/tinymce/jscripts/tiny_mce/tiny_mce_src.js" type="text/javascript" charset="utf-8"><\/script>').appendTo("head")};a.prototype.tinymce.init=function(f){var e,c="textarea.wysiwyg",d={};if(uAdmin.eip&&uAdmin.eip.editor){d.toolbar_standart=this.settings.toolbar_standart.replace(/^imagemanager,/,"");e={id:"mceEditor-"+new Date().getTime(),destroy:function(){var j=jQuery("#"+e.id),g=jQuery("#"+e.id+"_parent"),k=jQuery("iframe",g)[0],h;if(jQuery.browser.msie&&(typeof document.documentMode=="undefined"||document.documentMode<7)){h=window.frames[window.frames.length-1].document.body.innerHTML}else{h=k.contentDocument.body.innerHTML}j.html(h);g.remove();j.css("display","");j[0].id=""}};f.id=e.id;c="#"+e.id}d.language=uAdmin.data["interface-lang"]||uAdmin.data.lang;d=jQuery.extend(this.settings,d);tinyMCE.init(d);jQuery(c).each(function(g,h){tinyMCE.execCommand("mceAddControl",false,h.id)});return e};a.prototype.tinymce.settings={mode:"none",theme:"umi",width:"100%",language:"",plugins:"safari,spellchecker,pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,inlinepopups,insertdatetime,preview,media,searchreplace,print,contextmenu,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras,template,imagemanager",inlinepopups_skin:"butterfly",toolbar_standart:"imagemanager,fontsettings,tablesettings,|,cut,copy,paste,|,pastetext,pasteword,|,selectall,cleanup,|,undo,redo,|,link,unlink,anchor,image,media,|,charmap,code",toolbar_tables:"table,delete_table,|,col_after,col_before,row_after,row_before,|,delete_col,delete_row,|,split_cells,merge_cells,|,row_props,cell_props",toolbar_fonts:"formatselect,fontselect,fontsizeselect,|,bold,italic,underline,|,justifyleft,justifycenter,justifyright,justifyfull,|,bullist,numlist,outdent,indent,|,forecolor,backcolor,|,sub,sup",theme_umi_toolbar_location:"top",theme_umi_toolbar_align:"left",theme_umi_statusbar_location:"bottom",theme_umi_resize_horizontal:false,theme_umi_resizing:true,convert_urls:false,relative_urls:false,file_browser_callback:function(h,f,g,j){if(g=="file"){var e="/js/cms/wysiwyg/tinymce/jscripts/tiny_mce/themes/umi/treelink.html"+(window.lang_id?"?lang_id="+window.lang_id:"");tinyMCE.activeEditor.windowManager.open({url:e,width:525,height:308,inline:true,scrollbars:false,resizable:false,maximizable:false,close_previous:false},{window:j,input:h,editor_id:tinyMCE.selectedInstance.editorId});return false}else{var d=j.document.getElementById(h),k={},c=[];if(!d){return false}if(d.value.length){k.folder=d.value.substr(0,d.value.lastIndexOf("/"));k.file=d.value}c.push("id="+h);switch(g){case"image":c.push("image=1");break;case"media":c.push("media=1");break}jQuery.ajax({url:"/admin/data/get_filemanager_info/",data:k,dataType:"json",success:function(m){if(m.filemanager=="flash"){if(d.value.length){c.push("folder=."+k.folder);c.push("file="+d.value)}}else{c.push("folder_hash="+m.folder_hash);c.push("file_hash="+m.file_hash);c.push("lang="+m.lang)}var l={flash:{height:460,url:"/styles/common/other/filebrowser/umifilebrowser.html?"+c.join("&")},elfinder:{height:530,url:"/styles/common/other/elfinder/umifilebrowser.html?"+c.join("&")}};jQuery.openPopupLayer({name:"Filemanager",title:getLabel("js-file-manager"),width:660,height:l[m.filemanager].height,url:l[m.filemanager].url});if(m.filemanager=="elfinder"){window.parent.jQuery("#popupLayer_Filemanager .popupBody").append('\n								<div id="watermark_wrapper">\n									<label for="add_watermark">'+getLabel("js-water-mark")+'</label>\n									<input type="checkbox" name="add_watermark" id="add_watermark">\n								</div>\n							')}return false}})}return false},extended_valid_elements:"script[type=text/javascript|src|languge|lang],map[*],area[*],umi:*[*],input[*],noindex[*],nofollow[*],iframe[frameborder|src|width|height|name|align]",content_css:"/css/cms/style.css"};return b(a,this)});uAdmin(".session",function(b){function a(){var c=this;c.lifetime=parseInt(c.lifetime)||10;c.access=!!c.access;c.setLastAction();c.setCurrentPeriod();c.last_pinged_success=true;c.window_warning_closed=false;c.window_session_closed=false;(function d(){jQuery(document).bind("click keydown mousedown",function(){c.setLastAction()});setTimeout(function(){jQuery("iframe").each(function(){try{var g=this.contentWindow||this.contentDocument;if(g.document){g=g.document;jQuery(g).bind("click keydown mousedown",function(){c.setLastAction()})}}catch(f){}})},30*1000);c.timerAutoPing=setInterval(function(){c.checkAutoPing()},60*1000)})()}a.prototype.showWarningMessage=function(d){var c=this;if(d){clearInterval(c.timer);c.timer=null}if(c.timer){return}c.session_close_time=new Date();c.session_close_time.setMinutes(c.session_close_time.getMinutes()+1);c.timer=setInterval(function(){var k=new Date();var g=(c.session_close_time.getTime()-k.getTime());if(g>1){var h=(parseInt(g/1000));var j=(parseInt(h/60));var f=h-j*60;if(f<10){f="0"+f}var l=j+":"+f;var e=parseInt((new Date().getTime()-c.last_action_time.getTime())/60/1000);c.message("Вы отсутствуете "+e+" мин. Сессия скоро закончится <br>"+l)}else{clearInterval(c.timer);c.timer=null;jQuery.get("/session.php",function(m){switch(m){case"closed":c.sessionCloseMessage(true);break;case"warning":c.showWarningMessage(true);break;case"ok":c.closeMessage();c.setCurrentPeriod();break}})}},1000)};a.prototype.sessionCloseMessage=function(e){var c=this;if(e){clearInterval(c.timer);c.timer=null}if(c.timer){return}c.last_pinged_success=false;var f=jQuery("<div><br />Вы отсутствовали более "+c.lifetime+" мин, поэтому Ваша сессия была закончена.<br/><br/></div>");var d=jQuery('\n			<form>\n				<table cellspacing="5" width="100%" style="font-size:12px;">\n					<tr>\n						<td>Логин: </td>\n						<td><input type="text" name="session_contorl_login" /></td>\n					</tr>\n					<tr>\n						<td>Пароль:</td>\n						<td><input type="password" name="session_contorl_passsword" /></td>\n					</tr>\n				</table>\n				<br/>\n				<input type="submit" value="Хочу продлить сессию">\n			</form>\n		').appendTo(f);if(c.access){jQuery("<br/> <br/><a href='/admin/config/main/' target='_blank'>Настроить таймаут неактивности</a>").appendTo(d)}d.submit(function(){var h=jQuery.trim(this.session_contorl_login.value),g=jQuery.trim(this.session_contorl_passsword.value);if(h&&g){c.ping(h,g,function(j){if(j=="ok"){c.closeMessage();clearInterval(c.timer);c.timer=null;jQuery.jGrowl("Сессия успешно восстановлена!",{header:"UMI.CMS",life:5000})}else{jQuery.jGrowl("Ошибка! Неправильный логин или пароль",{header:"UMI.CMS",life:5000})}c.setCurrentPeriod()})}else{jQuery.jGrowl("Укажите логин и пароль для восстановления сессии!",{header:"UMI.CMS",life:5000})}return false});c.message(f);c.timer=1;c.setCurrentPeriod()};a.prototype.message=function(e){var c=this;if(typeof e=="string"){e="<br/><p> "+e+" </p>"}if(!c.jgrowl){c.jgrowl=jQuery('<div id="SessionjGrowl"></div>').addClass("top-right").appendTo("body");c.jgrowl.jGrowl(e,{header:"UMI.CMS",dont_close:true,close:function(){c.jgrowl=false}});return}var d=c.jgrowl.find(".jGrowl-notification .jGrowl-message");if(typeof e=="string"){d.html(e)}else{d.html("");d.append(e)}};a.prototype.closeMessage=function(){var c=this.jgrowl;if(c&&c.length){c.data("jGrowl.instance").shutdown();c.remove()}this.jgrowl=false};a.prototype.destroy=function(){if(this.timerAutoPing){clearInterval(this.timerAutoPing)}if(this.timer){clearInterval(this.timer);this.timer=0}return true};a.prototype.ping=function(d,e,f){var c=this,g={};if(d){g={"u-login":d,"u-password":e}}jQuery.post("/users/ping/",g,function(h){c.last_pinged_success=(h=="ok")?true:false;if(c.timerAutoPing){clearInterval(c.timerAutoPing)}c.timerAutoPing=setInterval(function(){c.checkAutoPing()},60*1000);if(typeof f=="function"){f(h)}})};a.prototype.setCurrentPeriod=function(){this.current_period_start_time=new Date();this.current_period_end_time=new Date();var c=this.current_period_start_time.getMinutes()+this.lifetime;this.current_period_end_time.setMinutes(c)};a.prototype.setLastAction=function(){this.last_action_time=new Date;if(this.last_pinged_success){this.closeMessage();clearInterval(this.timer);this.timer=null}};a.prototype.startAutoActions=function(){var c=this;c.timerAutoAction=setInterval(function(){c.setLastAction()},60000)};a.prototype.stopAutoActions=function(){if(this.timerAutoAction){clearInterval(this.timerAutoAction)}};a.prototype.getLastAction=function(){return this.last_action_time};a.prototype.isUserhere=function(){var d=(new Date().getTime()-this.last_action_time.getTime())/60000;var c=false;if(d<this.lifetime-0.2){c=true}return c};a.prototype.checkAutoPing=function(){if(!this.last_pinged_success){this.sessionCloseMessage();return false}if(this.timer){return false}var c=this,d=false,e=(c.current_period_end_time.getTime()-new Date().getTime())/60000;if(e<1.2){d=1}if(!d){return false}var f=c.isUserhere();if(f===false){jQuery.get("/session.php",function(g){this.settings_link=false;switch(g){case"ok":return;case"closed":c.sessionCloseMessage();break;case"warning":c.showWarningMessage();break;case"warning_settings":this.settings_link=true;c.showWarningMessage()}})}else{c.closeMessage();c.ping();c.setCurrentPeriod()}return false};return b(a,this)});function RGBColor(g){this.ok=false;if(g.charAt(0)=="#"){g=g.substr(1,6)}g=g.replace(/ /g,"");g=g.toLowerCase();var a={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};for(var c in a){if(g==c){g=a[c]}}var h=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(j){return[parseInt(j[1]),parseInt(j[2]),parseInt(j[3])]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(j){return[parseInt(j[1],16),parseInt(j[2],16),parseInt(j[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(j){return[parseInt(j[1]+j[1],16),parseInt(j[2]+j[2],16),parseInt(j[3]+j[3],16)]}}];for(var b=0;b<h.length;b++){var e=h[b].re;var d=h[b].process;var f=e.exec(g);if(f){channels=d(f);this.r=channels[0];this.g=channels[1];this.b=channels[2];this.ok=true}}this.r=(this.r<0||isNaN(this.r))?0:((this.r>255)?255:this.r);this.g=(this.g<0||isNaN(this.g))?0:((this.g>255)?255:this.g);this.b=(this.b<0||isNaN(this.b))?0:((this.b>255)?255:this.b);this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"};this.toHash=function(){return{red:this.r,green:this.g,blue:this.b}};this.inverse=function(){this.r=255-this.r;this.g=255-this.g;this.b=255-this.b};this.toHex=function(){var l=this.r.toString(16);var k=this.g.toString(16);var j=this.b.toString(16);if(l.length==1){l="0"+l}if(k.length==1){k="0"+k}if(j.length==1){j="0"+j}return"#"+l+k+j}}function relationControl(r,b,j,h){var e=this;var d=r;var v=b||r;var q=true;var y=null;var B=null;var s=null;var f=null;var C=null;var a=null;var c=null;var A=null;var t=null;var m=0;var l=0;var z=h||"/admin/data/guide_items_all/";var w=function(){y=document.getElementById("relationSelect"+v);B=document.getElementById("relationInput"+v);s=document.getElementById("relationButton"+v);if(!y){alert("Select input for field #"+v+" not found");return}jQuery("option",y).each(function(){if(!this.selected&&this.value.length!==0){q=false}});if(s){s.onclick=function(){e.addItem()}}if(B){B.onkeyup=function(G){var F=G?G.keyCode:event.keyCode;if(F==13&&s){e.addItem();return false}else{e.doSearch()}};B.onkeydown=function(G){var F=G?G.keyCode:event.keyCode;if(F==13){return false}}}var E=function(){if(q){e.loadItemsAll();q=false}};y.onmouseover=E;y.onfocus=E;for(var D=0;D<y.childNodes.length;D++){if(y.childNodes[D].nodeType!=1){y.removeChild(y.childNodes[D]);D=0}}if(j&&jQuery("option[value='']",y).size()==0){jQuery(y).prepend("<option value=''></option>")}};this.rescan=function(){B=document.getElementById("relationInput"+v);if(B){B.onkeyup=function(E){var D=E?E.keyCode:event.keyCode;if(D==13&&s){e.addItem()}else{e.doSearch()}}}};this.getValue=function(){var F=jQuery("option:selected",jQuery(y));var D={};for(var E=0;E<F.length;E++){D[F[E].value]=jQuery(F[E]).text()}return D};this.loadItems=function(D){jQuery.ajax({url:z+d+".xml?limit&search[]="+encodeURIComponent(D),type:"get",complete:function(F,E){e.updateItems(F)}})};this.loadItemsAll=function(){jQuery.ajax({url:z+d+".xml?allow-empty",type:"get",complete:function(E,D){e.updateItemsAll(E)}})};this.updateItemsAll=function(E){if(E.responseXML.getElementsByTagName("empty").length){if(B){B.onkeyup=function(P){var O=P?P.keyCode:event.keyCode;switch(O){case 38:if(A.length&&(t>0||t==null)){g((t===null)?(A.length-1):(t-1))}break;case 40:if(A.length&&(t<(A.length-1)||t==null)){g((t===null)?0:(t+1))}break;case 13:k();n();break;case 27:n();break;default:clearTimeout(c);c=setTimeout(function(){e.doSearchAjax()},500)}};B.onblur=function(){if(a){if(m<parseInt(a.style.left)||m>(parseInt(a.style.left)+parseInt(a.offsetWidth))||l<parseInt(a.style.top)||l>(parseInt(a.style.top)+parseInt(a.offsetHeight))){n()}}};var K=E.responseXML.getElementsByTagName("empty")[0].getAttribute("total");if(!C){C=new Option(" ","");C.innerHTML=getLabel("js-relation-total")+K+". "+getLabel("js-relation-use_search");y.insertBefore(C,y.firstChild)}}return}var I=E.responseXML.getElementsByTagName("object");var L=[];var F=0;for(F=0;F<y.options.length;F++){if(y.options[F].selected){L.push(y.options[F].value)}}jQuery("option",y).each(function(){if(!this.selected||this.value.length===0){jQuery(this).remove()}});if(j){$(y).prepend("<option value=''> </option>")}for(F=0;F<I.length;F++){var J=I[F].getAttribute("id");var G=false;for(var M in L){if(L[M]==J){G=true;delete L[M];break}}if(!G){var N=I[F].getAttribute("name");var D=new Option(N,J);D.innerHTML=N;y.appendChild(D)}}if(jQuery.browser.msie){var H=y.style.display;y.style.display="none";y.style.display=H}};this.updateItems=function(E){t=null;A=E.responseXML.getElementsByTagName("object");if(!A.length){return}var F=null;if(!a){a=document.createElement("div");a.className="relationAutosuggest";var H=jQuery(B).offset();a.style.position="absolute";a.style.zIndex=1050;a.style.width=B.clientWidth+"px";a.style.top=(H.top+B.offsetHeight)+"px";a.style.left=H.left+"px";F=document.createElement("ul");a.appendChild(F);document.body.appendChild(a)}a.style.display="";jQuery(document).mousemove(o);F=a.firstChild;while(F.firstChild){F.removeChild(F.firstChild)}for(i=0;i<A.length;i++){var G=A[i].getAttribute("name");var D=document.createElement("li");D.innerHTML=G;D.onmouseover=function(){g(this.suggestIndex)};D.onmouseout=function(){this.className=""};D.onclick=function(){k();n()};D.suggestIndex=i;F.appendChild(D)}};var o=function(D){if(!D){m=event.clientX+document.body.scrollLeft;l=event.clientY+document.body.scrollTop}else{m=D.pageX;l=D.pageY}return true};this.addItem=function(E,D){if(!(E&&E.length)&&!(B&&B.value.length)){return}x();u();if(!y.multiple&&f&&!E&&!D){f.innerHTML=(D?"":"&rarr;&nbsp;&nbsp;")+B.value;f.value=D?D:B.value;y.selectedIndex=0}else{f=new Option(E?E:B.value,D?D:B.value);f.innerHTML=(D?"":"&rarr;&nbsp;&nbsp;")+(E?E:B.value);if(y.options.length){y.insertBefore(f,y.firstChild)}else{y.appendChild(f)}}B.value="";f.selected=true;if(jQuery.browser.msie){setTimeout(function(){f.selected=false;f.selected=true},20)}};var g=function(E){if(a.style.display!="none"){var F=a.firstChild;var D=F.childNodes.item(t);if(D){D.className=""}F.childNodes.item(E).className="active";t=E}};var k=function(){if(a&&a.style.display!="none"&&t!==null){var G=A[t].getAttribute("name");var F=A[t].getAttribute("id");var E=false;for(var D=0;D<y.options.length;D++){if(y.options[D].value==F){E=true;y.options[D].selected=true;break}}if(!E){e.addItem(G,F)}}else{if(B.value.length&&s){e.addItem()}}};var n=function(){if(a&&a.style.display!="none"){a.style.display="none";jQuery(document).unbind("mousemove",o)}};this.doSearch=function(){var G=B.value.toLowerCase();x();if(G==""){if(y.multiple){u()}return}for(var E=0;E<y.options.length;E++){var H=y.options[E].text;var F=H.replace(/^.\s\s/,"");if(H.substring(0,G.length).toLowerCase()===G||F.substring(0,G.length).toLowerCase()===G){if(y.multiple){if(y.firstChild.nodeName.toLowerCase()!="optgroup"){p();searchGroup=y.firstChild;itemsGroup=y.lastChild}var D=y.options[E];if(D.parentNode==searchGroup){continue}D.oldPrevSibling=D.previousSibling;itemsGroup.removeChild(D);searchGroup.appendChild(D);if(searchGroup.childNodes.length==5){return}}else{y.selectedIndex=E;return}}}};this.doSearchAjax=function(){if(B.value){this.loadItems(B.value)}};var p=function(){var E=document.createElement("optgroup");E.label="Search results";var D=document.createElement("optgroup");D.label="------------------------------------------------";while(y.firstChild){var F=y.firstChild;y.removeChild(F);D.appendChild(F)}y.appendChild(E);y.appendChild(D)};var u=function(){if(y.firstChild&&y.firstChild.nodeName.toLowerCase()=="optgroup"){y.removeChild(y.firstChild);var D=y.firstChild;while(D.firstChild){var E=D.firstChild;D.removeChild(E);y.appendChild(E)}y.removeChild(D)}};var x=function(){if(y.firstChild&&y.firstChild.nodeName.toLowerCase()=="optgroup"){var E=y.firstChild;var D=y.lastChild;while(E.firstChild){var F=E.firstChild;E.removeChild(F);if(F.oldPrevSibling!==undefined||F.oldPrevSibling==null){if(F.oldPrevSibling&&F.oldPrevSibling.nextSibling){D.insertBefore(F,F.oldPrevSibling.nextSibling)}else{if(F.oldPrevSibling===null){D.insertBefore(F,D.firstChild)}else{D.appendChild(F)}}F.oldPrevSibling=undefined}}}};w()}function symlinkControl(f,t,c,A,r){r=(r instanceof Array)?r:[r];var h=this;var y=f;var u=(c instanceof Array)?c:[c];var l=(u)?"&hierarchy_types="+u.join("-"):"";var F=(r instanceof Array)?"&hierarchy_types="+r.join(","):"";var e=t||null;var v=null;var I=null;var g=null;var a=null;var b=null;var G=null;var z=null;var q=0;var o=0;if(!A){A={}}var x=A.iconsPath||"/images/cms/admin/mac/tree/";var D=A.fadeColorStart||[255,0,0];var H=A.fadeColorEnd||[255,255,255];var p=A.inputName||("symlinkInput"+y);var C=A.noImages||false;var k={};var E=function(){if(!window.symlinkControlsList){window.symlinkControlsList={}}window.symlinkControlsList[y]=h;v=document.getElementById("symlinkInput"+y);if(!v){alert("Symlink container #"+y+" not found");return}var J=document.createElement("input");J.type="hidden";J.name=p;v.parentNode.insertBefore(J,v);a=document.createElement("ul");v.appendChild(a);I=document.createElement("input");v.appendChild(I);g=C?document.createElement("input"):document.createElement("img");v.appendChild(g);I.type="text";if(C){g.type="button";g.value="╘"}else{g.src="/images/cms/admin/mac/tree.png";g.height="18"}g.className="treeButton";g.onclick=function(){jQuery.openPopupLayer({name:"Sitetree",title:"Выбор страницы",width:620,height:335,url:"/styles/common/js/tree.html?id="+y+(e?"&module="+e:"")+F+(window.lang_id?"&lang_id="+window.lang_id:"")})};a.className="pageslist";I.onkeypress=function(L){var K=L?L.keyCode:window.event.keyCode;if(K==13){return false}};I.onkeyup=function(L){var K=L?L.keyCode:window.event.keyCode;switch(K){case 38:if(G.length&&(z>0||z==null)){j((z===null)?(G.length-1):(z-1))}break;case 40:if(G.length&&(z<(G.length-1)||z==null)){j((z===null)?0:(z+1))}break;case 13:n();s();return false;break;case 27:s();break;default:h.doSearch()}};I.onblur=function(){if(b){if(q<parseInt(b.style.left)||q>(parseInt(b.style.left)+parseInt(b.offsetWidth))||o<parseInt(b.style.top)||o>(parseInt(b.style.top)+parseInt(b.offsetHeight))){s()}}}};this.loadItems=function(J){jQuery.ajax({url:"/admin/content/load_tree_node.xml?limit&domain_id[]="+(window.domain_id?window.domain_id:"1")+l+(window.lang_id?"&lang_id="+window.lang_id:"")+"&search-all-text[]="+encodeURIComponent(J),type:"get",complete:function(L,K){h.updateItems(L)}})};this.updateItems=function(K){var L=(jQuery("html.u-eip").size()>0);z=null;G=K.responseXML.getElementsByTagName("page");if(!G.length){return}var M=[];for(var N=0;N<G.length;N++){if(k[G[N].getAttribute("id")]){continue}M[M.length]=G[N]}G=M;var O=null;if(!b){b=document.createElement("div");b.className="symlinkAutosuggest";var R=jQuery(I).offset();b.style.position="absolute";b.style.zIndex=1050;b.style.width=I.clientWidth+"px";b.style.top=(R.top+I.offsetHeight)+"px";b.style.left=R.left+"px";if(L){b.style.backgroundColor="white";b.style.border="1px solid #ccc"}O=document.createElement("ul");b.appendChild(O);document.body.appendChild(b)}m();jQuery(document).mousemove(w);O=b.firstChild;while(O.firstChild){O.removeChild(O.firstChild)}for(N=0;N<G.length;N++){if(k[G[N].getAttribute("id")]){continue}var J=d(G[N].getElementsByTagName("name")[0]);var P=d(G[N].getElementsByTagName("basetype")[0]);var Q=G[N].getAttribute("link");var U=document.createElement("li");var T=document.createElement("span");var S=document.createElement("a");U.title=J;if(J.length>20){J=J.substr(0,20)+"..."}if(Q.length>55){Q=Q.substr(0,55)+"..."}U.appendChild(document.createTextNode(J));U.appendChild(T);T.appendChild(document.createTextNode(" ("+P+")"));if(!L){U.appendChild(document.createElement("br"));U.appendChild(S);S.appendChild(document.createTextNode(Q));S.href=Q;S.target="_blank"}else{T.style.display="block";U.className="symlink-item-delete";U.style.padding="3px"}U.onmouseover=function(){j(this.suggestIndex)};U.onclick=function(){n();s()};U.suggestIndex=N;O.appendChild(U)}};this.doSearch=function(){var J=I.value;h.loadItems(J)};var j=function(L){var K=(jQuery("html.u-eip").size()>0);if(b.style.display!="none"){var M=b.firstChild;var J=M.childNodes.item(z);if(J){if(K){J.style.backgroundColor=""}else{J.className=""}}if(K){M.childNodes.item(L).style.backgroundColor="#ceeaf6"}else{M.childNodes.item(L).className="active"}z=L}};var n=function(){if(b&&b.style.display!="none"&&z!==null){var P=G[z].getAttribute("id");var K=d(G[z].getElementsByTagName("name")[0]);var J=G[z].getAttribute("link");var N=G[z].getElementsByTagName("basetype")[0];var M="";var L=(M=N.getAttribute("module"))?M:"";var O=(M=N.getAttribute("method"))?M:"";h.addItem(P,K,[L,O],J)}};this.addItem=function(N,K,O,L){if(k[N]!==undefined){return}var P=(jQuery("html.u-eip").size()>0);var Q=document.createElement("li");var U=document.createElement("span");var S=document.createElement("a");var M=document.createElement("a");var T=document.createElement("input");T.type="hidden";T.name=p;T.value=N;M.input=T;S.href=L;if(C){M.appendChild(document.createTextNode("[x]"))}else{var J=document.createElement("img");J.src=x+"symlink_delete.png";J.alt="delete";if(P){J.className="symlink-item-delete"}M.appendChild(J)}M.href="javascript:void(0);";if(P){M.style.marginRight="5px"}else{M.className="button"}M.onclick=function(){this.input.parentNode.removeChild(this.input);a.removeChild(this.parentNode);delete k[N]};U.title=O[0]+" "+O[1];if(P){U.style.marginLeft="5px";U.style.position="relative";U.style.top="-3px"}U.appendChild(document.createTextNode(K));S.appendChild(document.createTextNode(L));Q.appendChild(M);if(!C){var R=document.createElement("img");R.src=x+"ico_"+O[0]+"_"+O[1]+".png";Q.appendChild(R)}Q.appendChild(U);if(P){delete S}else{Q.appendChild(S)}a.appendChild(Q);v.parentNode.insertBefore(T,v);Q.style.backgroundColor=makeHexRgb(D);Q.startColor=D;Q.endColor=H;Q.pname=K;Q.fade=B;setTimeout(function(){Q.fade()},2000);k[N]=true;if(jQuery("#eip_page").size()){frameElement.height=(jQuery("#eip_page").height()>500)?500:jQuery("#eip_page").height()}};var B=function(){if(this.fadeColor==undefined){this.fadeColor=[];this.fadeColor[0]=this.startColor[0];this.fadeColor[1]=this.startColor[1];this.fadeColor[2]=this.startColor[2]}if(Math.round(this.fadeColor[0]+this.fadeColor[1]+this.fadeColor[2])==Math.round(this.endColor[0]+this.endColor[1]+this.endColor[2])){return}this.fadeColor[0]+=(this.endColor[0]-this.startColor[0])/50;this.fadeColor[1]+=(this.endColor[1]-this.startColor[1])/50;this.fadeColor[2]+=(this.endColor[2]-this.startColor[2])/50;this.style.backgroundColor=makeHexRgb(this.fadeColor);var J=this;setTimeout(function(){J.fade()},20)};var m=function(){if(b){var J=jQuery(I).offset();b.style.width=I.clientWidth;b.style.top=J.top+I.offsetHeight;b.style.left=J.left;b.style.display=""}};var s=function(){if(b&&b.style.display!="none"){b.style.display="none";jQuery(document).unbind("mousemove",w)}};var w=function(J){if(!J){q=event.clientX+document.body.scrollLeft;o=event.clientY+document.body.scrollTop}else{q=J.pageX;o=J.pageY}return true};var d=function(J){return(J.firstChild&&J.firstChild.nodeType==3)?J.firstChild.nodeValue:J.nodeValue};E()}var hex=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function makeHexRgb(b){var a="";for(var c=0;c<3;c++){a=a+hex[Math.floor(b[c]/16)]+hex[Math.floor(b[c]%16)]}return"#"+a};